<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coach Portal | Planexa</title>
  <meta name="description" content="Coach Dashboard for managing clients and business" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="/js/auth-helper.js"></script>

  <!-- Import Main Styles to match App exactly -->
  <link rel="stylesheet" href="../../css/styles.css?v=role1" />

  <style>
    /* Tab System matching app.html */
    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block !important;
    }

    /* Animation matching app.html/styles.css */
    @keyframes fade-in {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .fade-in {
      animation: fade-in 0.3s ease-in-out;
    }

    /* Premium Card Styles */
    .glass-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease, background 0.3s ease;
      will-change: transform, box-shadow;
      backface-visibility: hidden;
      transform: translateZ(0);
    }

    .glass-card:hover {
      box-shadow: 0 20px 40px -10px rgba(31, 38, 135, 0.15);
      background: rgba(255, 255, 255, 0.85);
    }

    .stat-card {
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle at center, var(--glow-color, rgba(99, 102, 241, 0.1)) 0%, transparent 70%);
      transform: translate(30%, -30%);
      pointer-events: none;
    }

    .user-card {
      background: white;
      border: 1px solid #f1f5f9;
      border-radius: 1.5rem;
      padding: 1.5rem;
      transition: all 0.2s ease;
    }

    .user-card:hover {
      border-color: #e2e8f0;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
    }

    /* Dropdown Animation */
    #coach-profile-dropdown.show {
      opacity: 1;
      pointer-events: auto;
      transform: scale(100%);
    }

    .dropdown-item {
      cursor: pointer;
    }
  </style>
</head>

<body style="background-color: #e0f2ff;"> <!-- Exact User App BG -->

  <!-- HEADER: Exact replica of app.html header structure -->
  <header class="sticky top-0 z-10 header-dark">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center gap-4">

      <!-- Brand -->
      <a href="#" onclick="event.preventDefault(); window.location.replace('#');" class="flex items-center gap-3">
        <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center">
          <i data-lucide="rocket" class="w-6 h-6 text-white"></i>
        </div>
        <span
          class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">Planexa</span>
      </a>

      <!-- Nav Tabs -->
      <nav class="ml-auto">
        <ul class="flex gap-2 items-center" id="tabs">
          <li><button data-tab="users" class="tab-btn active">Users</button></li>
          <li><button data-tab="analytics" class="tab-btn">Analytics</button></li>
          <li><button data-tab="approvals" class="tab-btn flex items-center gap-1">Approvals <span id="approval-count"
                class="hidden bg-orange-600 text-white text-[9px] font-black px-1.5 py-0.5 rounded-full shadow-lg shadow-orange-200 animate-pulse">0</span></button>
          </li>
          <li><button data-tab="messages" class="tab-btn flex items-center gap-1.5 relative">
              <i data-lucide="message-square" class="w-3.5 h-3.5"></i> Messages
              <span id="total-messages-count"
                class="hidden bg-red-500 text-white text-[9px] font-black px-1.5 py-0.5 rounded-full shadow-lg shadow-red-200">0</span>
            </button></li>
          <li><button data-tab="announcements" class="tab-btn flex items-center gap-1.5 relative">
              <i data-lucide="megaphone" class="w-3.5 h-3.5"></i> Announcements
            </button></li>



          <!-- Profile Dropdown -->
          <li class="relative ml-4" id="coach-profile-dropdown-container">
            <button id="coach-profile-btn"
              class="flex items-center gap-3 px-3 py-2 rounded-2xl bg-white/10 hover:bg-white/20 transition-all border border-white/10 group">
              <div id="nav-profile-img-container"
                class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-indigo-500/20 transition-transform overflow-hidden">
                <i data-lucide="user" class="w-4 h-4"></i>
              </div>
              <span class="font-black text-white text-xs uppercase tracking-widest hidden sm:block">Profile</span>
              <i data-lucide="chevron-down" id="nav-profile-chevron"
                class="w-4 h-4 text-white/40 transition-transform"></i>
            </button>

            <!-- Dropdown Menu -->
            <div id="coach-profile-dropdown"
              class="absolute right-0 mt-3 w-64 bg-white/95 backdrop-blur-xl rounded-[2rem] shadow-2xl border border-slate-200/50 overflow-hidden transform scale-95 opacity-0 pointer-events-none transition-all duration-300 z-50 origin-top-right">
              <div class="p-4 space-y-1.5">
                <!-- Edit Profile -->
                <button data-tab="profile"
                  class="dropdown-item w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-slate-50 transition-all group text-left">
                  <div
                    class="w-10 h-10 bg-indigo-50 rounded-xl text-indigo-600 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-all shadow-sm">
                    <i data-lucide="user-cog" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <span class="block font-black text-slate-800 text-xs uppercase tracking-tight">Edit Profile</span>
                    <span class="block text-[10px] font-bold text-slate-400 uppercase leading-none mt-1">Public
                      Portfolio</span>
                  </div>
                </button>

                <!-- Create Article -->
                <button data-tab="create"
                  class="dropdown-item w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-slate-50 transition-all group text-left">
                  <div
                    class="w-10 h-10 bg-purple-50 rounded-xl text-purple-600 flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition-all shadow-sm">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <span class="block font-black text-slate-800 text-xs uppercase tracking-tight">Create Article</span>
                    <span class="block text-[10px] font-bold text-slate-400 uppercase leading-none mt-1">Publish to
                      Blog</span>
                  </div>
                </button>

                <!-- Settings -->
                <button data-tab="settings"
                  class="dropdown-item w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-slate-50 transition-all group text-left text-red-600">
                  <div
                    class="w-10 h-10 bg-red-50 rounded-xl text-red-600 flex items-center justify-center group-hover:bg-red-600 group-hover:text-white transition-all shadow-sm">
                    <i data-lucide="shield-alert" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <span class="block font-black text-slate-800 text-xs uppercase tracking-tight">Settings</span>
                    <span class="block text-[10px] font-bold text-red-400 uppercase leading-none mt-1">Danger
                      Zone</span>
                  </div>
                </button>

                <!-- Demo Tour -->
                <button id="coach-demo-tour-btn"
                  class="dropdown-item w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-indigo-50 transition-all group text-left text-indigo-600">
                  <div
                    class="w-10 h-10 bg-indigo-50 rounded-xl text-indigo-600 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-all shadow-sm">
                    <i data-lucide="play-circle" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <span class="block font-black text-slate-800 text-xs uppercase tracking-tight">Demo Tour</span>
                    <span class="block text-[10px] font-bold text-indigo-400 uppercase leading-none mt-1">Replay
                      Guide</span>
                  </div>
                </button>

                <div class="h-px bg-slate-100 my-2 mx-2"></div>

                <!-- Log Out -->
                <button id="logoutBtn"
                  class="dropdown-item w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-red-50 transition-all group text-left">
                  <div
                    class="w-10 h-10 bg-white border border-red-100 rounded-xl text-red-600 flex items-center justify-center group-hover:bg-red-600 group-hover:text-white transition-all shadow-sm">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <span class="block font-black text-red-600 text-xs uppercase tracking-tight">Log Out</span>
                    <span class="block text-[10px] font-bold text-slate-400 uppercase leading-none mt-1">Secure Sign
                      Out</span>
                  </div>
                </button>
              </div>
            </div>
          </li>
        </ul>
      </nav>

    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="max-w-5xl mx-auto px-4 py-8">

    <!-- TAB: USERS -->
    <section id="tab-users" class="tab-panel active fade-in">

      <!-- Stats Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
        <div id="stat-total-clients" class="glass-card stat-card p-6 rounded-3xl"
          style="--glow-color: rgba(59, 130, 246, 0.15)">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xs font-bold text-blue-600 uppercase tracking-wider">Total Clients</p>
              <h3 class="text-4xl font-black text-slate-800 mt-2">0</h3>
            </div>
            <div class="p-3 bg-blue-50 text-blue-600 rounded-2xl shadow-inner"><i data-lucide="users"
                class="w-6 h-6"></i></div>
          </div>
          <div class="mt-4 text-xs font-medium text-slate-400 flex items-center gap-2">
            <span class="flex h-2 w-2 rounded-full bg-blue-400"></span>
            <span>Active learning sessions</span>
          </div>
        </div>

        <div id="stat-total-revenue" class="glass-card stat-card p-6 rounded-3xl"
          style="--glow-color: rgba(168, 85, 247, 0.15)">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xs font-bold text-purple-600 uppercase tracking-wider">Total Revenue</p>
              <h3 class="text-4xl font-black text-slate-800 mt-2">â‚¹0</h3>
            </div>
            <div class="p-3 bg-purple-50 text-purple-600 rounded-2xl shadow-inner"><i data-lucide="banknote"
                class="w-6 h-6"></i></div>
          </div>
          <div class="mt-4 text-xs font-medium text-slate-400 flex items-center gap-2">
            <span class="flex h-2 w-2 rounded-full bg-purple-400"></span>
            <span>Platform earnings</span>
          </div>
        </div>
      </div>

      <!-- Clients Section -->
      <div class="glass-card p-6 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
        <div class="flex items-center justify-between mb-8">
          <div>
            <h2 class="text-2xl font-black text-slate-800">My Clients</h2>
            <p class="text-sm text-slate-500 font-medium">Manage and monitor your active students</p>
          </div>
        </div>

        <!-- Empty State Container -->
        <div id="no-clients-msg" class="flex flex-col items-center justify-center p-16 text-center hidden">
          <div class="w-20 h-20 bg-indigo-50 text-indigo-200 rounded-3xl flex items-center justify-center mb-6">
            <i data-lucide="users" class="w-10 h-10"></i>
          </div>
          <h3 class="text-xl font-bold text-slate-800">No clients yet</h3>
          <p class="text-slate-500 max-w-xs mx-auto mt-2">When you approve student requests, they will appear here as
            your active clients.</p>
        </div>

        <!-- Users Grid (Now a Vertical Stack) -->
        <div id="users-grid" class="flex flex-col gap-4">
          <!-- Populated by JS -->
        </div>
      </div>
    </section>

    <!-- TAB: ANALYTICS -->
    <section id="tab-analytics" class="tab-panel fade-in">
      <div class="glass-card mb-8 flex flex-col md:flex-row md:items-center justify-between p-6 rounded-[2rem] gap-4">
        <div>
          <h2 class="text-2xl font-black text-slate-800">Performance Tracking</h2>
          <p class="text-sm text-slate-500 font-medium">Analyze overall growth or individual student progress</p>
        </div>
        <div class="flex items-center gap-4 bg-slate-50 p-2 rounded-2xl border border-slate-100">
          <label for="analytics-filter"
            class="text-xs font-bold text-slate-500 uppercase px-2 tracking-wider">Viewing:</label>
          <select id="analytics-filter" onchange="handleAnalyticsFilterChange()"
            class="rounded-xl border-none focus:ring-0 text-sm font-bold p-2.5 bg-white text-indigo-600 shadow-sm cursor-pointer min-w-[180px]">
            <option value="overall">Overall Workspace</option>
            <!-- Students populated via JS -->
          </select>
        </div>
      </div>

      <!-- OVERALL VIEW -->
      <div id="overall-analytics-view" class="space-y-8">
        <!-- Client Distribution Grid (Total Stats) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="glass-card p-6 rounded-3xl border border-slate-100">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Total Managed Clients</p>
            <h4 id="overall-total-clients" class="text-3xl font-black text-slate-800">0</h4>
          </div>
          <div class="glass-card p-6 rounded-3xl border border-slate-100">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Active This Week</p>
            <h4 id="overall-active-clients" class="text-3xl font-black text-slate-800">0</h4>
          </div>
          <div class="glass-card p-6 rounded-3xl border border-slate-100">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Avg. Progress</p>
            <h4 id="overall-avg-progress" class="text-3xl font-black text-slate-800">0%</h4>
          </div>
        </div>

        <!-- Client List - Focus of overall workspace -->
        <div class="glass-card p-8 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
          <h3 class="text-lg font-black text-slate-800 mb-6 flex items-center gap-2">
            <i data-lucide="users" class="w-5 h-5 text-indigo-600"></i> Client Performance Summary
          </h3>
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead>
                <tr class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-50">
                  <th class="pb-4 px-2">Client</th>
                  <th class="pb-4 px-2">Task Progress</th>
                  <th class="pb-4 px-2">Status</th>
                  <th class="pb-4 px-2">Action</th>
                </tr>
              </thead>
              <tbody id="overall-client-list-body" class="divide-y divide-slate-50">
                <!-- Populated via JS -->
              </tbody>
            </table>
          </div>
        </div>

      </div>

      <!-- STUDENT VIEW -->
      <div id="student-analytics-view" class="hidden space-y-8">
        <!-- Student Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div class="flex items-center gap-4">
            <div id="student-view-avatar"
              class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center text-xl font-black shadow-lg shadow-indigo-200">
              ?
            </div>
            <div>
              <h3 id="student-view-name" class="text-2xl font-black text-slate-800">Student Name</h3>
              <p id="student-view-email" class="text-xs font-bold text-slate-400 uppercase tracking-widest">
                student@example.com</p>
            </div>
          </div>
          <div id="student-productivity-badge"
            class="px-6 py-2.5 rounded-2xl text-xs font-black uppercase tracking-widest bg-emerald-50 text-emerald-600 border border-emerald-100 shadow-sm shadow-emerald-100/50">
            Productivity: 0%
          </div>
        </div>

        <!-- Student Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Weekly Goals Card -->
          <div class="glass-card stat-card p-6 rounded-3xl" style="--glow-color: rgba(59, 130, 246, 0.15)">
            <div class="flex justify-between items-start">
              <div>
                <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest">Weekly Goals</p>
                <h3 id="student-weekly-goals" class="text-3xl font-black text-slate-800 mt-2">0/0</h3>
              </div>
              <div class="p-3 bg-blue-50 text-blue-600 rounded-2xl shadow-inner"><i data-lucide="target"
                  class="w-5 h-5"></i></div>
            </div>
            <div class="mt-4 text-[10px] font-bold text-slate-400 flex items-center gap-2">
              <span class="flex h-1.5 w-1.5 rounded-full bg-blue-400"></span>
              <span>Goals done this week</span>
            </div>
          </div>

          <!-- Most Active Day Card -->
          <div class="glass-card stat-card p-6 rounded-3xl" style="--glow-color: rgba(168, 85, 247, 0.15)">
            <div class="flex justify-between items-start">
              <div>
                <p class="text-[10px] font-black text-purple-600 uppercase tracking-widest">Peak Activity</p>
                <h3 id="student-active-day" class="text-3xl font-black text-slate-800 mt-2">-</h3>
              </div>
              <div class="p-3 bg-purple-50 text-purple-600 rounded-2xl shadow-inner"><i data-lucide="zap"
                  class="w-5 h-5"></i></div>
            </div>
            <div class="mt-4 text-[10px] font-bold text-slate-400 flex items-center gap-2">
              <span class="flex h-1.5 w-1.5 rounded-full bg-purple-400"></span>
              <span>Most active day</span>
            </div>
          </div>

          <!-- Percentage To-Do Card -->
          <div class="glass-card stat-card p-6 rounded-3xl" style="--glow-color: rgba(16, 185, 129, 0.15)">
            <div class="flex justify-between items-start">
              <div>
                <p class="text-[10px] font-black text-emerald-600 uppercase tracking-widest">Effort Left</p>
                <h3 id="student-perc-left" class="text-3xl font-black text-slate-800 mt-2">0%</h3>
              </div>
              <div class="p-3 bg-emerald-50 text-emerald-600 rounded-2xl shadow-inner"><i data-lucide="clock"
                  class="w-5 h-5"></i></div>
            </div>
            <div class="mt-4 text-[10px] font-bold text-slate-400 flex items-center gap-2">
              <span class="flex h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
              <span>Percentage left to do</span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Student Activity Chart -->
          <div
            class="lg:col-span-2 glass-card p-8 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
            <h3 class="text-lg font-black text-slate-800 mb-8 flex items-center gap-2">
              <i data-lucide="bar-chart-2" class="w-5 h-5 text-indigo-600"></i> Weekly Activity
            </h3>
            <div class="relative h-[250px] w-full">
              <canvas id="studentActivityChart"></canvas>
            </div>
          </div>

          <!-- Goal Status Radial Chart -->
          <div class="col-span-1 glass-card p-8 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
            <h3 class="text-lg font-black text-slate-800 mb-8 flex items-center gap-2">
              <i data-lucide="pie-chart" class="w-5 h-5 text-indigo-600"></i> Goal Status
            </h3>
            <div class="relative h-[250px] w-full flex items-center justify-center">
              <canvas id="studentGoalChart"></canvas>
              <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <span id="goal-done-count" class="text-2xl font-black text-slate-800">0</span>
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Done</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Live Goal Tracking & Recent Activity -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="glass-card p-8 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
            <h3 class="text-lg font-black text-slate-800 mb-8 flex items-center gap-2">
              <i data-lucide="target" class="w-5 h-5 text-indigo-600"></i> Goal Progress
            </h3>
            <div id="individual-goals-list" class="space-y-6">
              <!-- Populated via JS -->
            </div>
          </div>
          <div class="glass-card p-8 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
            <h3 class="text-lg font-black text-slate-800 mb-8 flex items-center gap-2">
              <i data-lucide="list-checks" class="w-5 h-5 text-emerald-600"></i> Recent Tasks
            </h3>
            <div id="individual-recent-tasks" class="space-y-4">
              <!-- Populated via JS -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: APPROVALS -->
    <section id="tab-approvals" class="tab-panel fade-in">
      <div class="glass-card p-6 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
        <div class="flex items-center justify-between mb-8">
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="flex h-2 w-2 rounded-full bg-orange-500 animate-ping"></span>
              <h2 class="text-2xl font-black text-slate-800">New Coaching Requests</h2>
            </div>
            <p class="text-sm text-slate-500 font-medium">Review and approve new potential clients wanting to join you
            </p>
          </div>
        </div>

        <!-- Empty State Container -->
        <div id="approvals-empty" class="flex flex-col items-center justify-center p-16 text-center hidden">
          <div class="w-20 h-20 bg-orange-50 text-orange-200 rounded-3xl flex items-center justify-center mb-6">
            <i data-lucide="shield-check" class="w-10 h-10"></i>
          </div>
          <h3 class="text-xl font-bold text-slate-800">All caught up!</h3>
          <p class="text-slate-500 max-w-xs mx-auto mt-2">There are no pending coaching requests at the moment. Great
            job!</p>
        </div>

        <!-- Requests Stack -->
        <div id="approvals-list" class="flex flex-col gap-4">
          <!-- Populated by JS -->
        </div>
      </div>
    </section>
    <section id="tab-profile" class="tab-panel fade-in">
      <div class="max-w-4xl mx-auto">
        <!-- Profile Header / Banner -->
        <div
          class="glass-card mb-8 overflow-hidden rounded-[2.5rem] border border-slate-100 shadow-2xl shadow-slate-200/50">
          <div class="h-44 bg-gradient-to-br from-indigo-600 via-purple-600 to-indigo-700 relative overflow-hidden">
            <!-- Mesh Glow Effects -->
            <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -mr-20 -mt-20"></div>
            <div class="absolute bottom-0 left-0 w-48 h-48 bg-purple-400/20 rounded-full blur-2xl -ml-10 -mb-10">
            </div>
          </div>

          <div class="relative px-10 pb-10">
            <div class="flex flex-col md:flex-row md:items-end justify-between -mt-16 gap-6">
              <div class="flex flex-col md:flex-row md:items-end gap-6">
                <div class="relative group">
                  <div
                    class="absolute -inset-1.5 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-[2.5rem] blur opacity-20 transition duration-500 group-hover:opacity-40">
                  </div>
                  <img id="profile-img" src="https://ui-avatars.com/api/?name=Coach&background=random"
                    class="relative w-36 h-36 rounded-[2.2rem] border-4 border-white shadow-2xl object-cover bg-white">
                </div>
                <div class="pb-2">
                  <h2 id="profile-name" class="text-4xl font-black text-slate-800 tracking-tight">Loading...</h2>
                  <div class="flex items-center gap-2 mt-2">
                    <span id="profile-category"
                      class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-black uppercase tracking-widest border border-indigo-100/50">Business</span>
                    <span class="text-slate-400 font-bold text-sm" id="profile-email">...</span>
                  </div>
                </div>
              </div>

              <div class="flex gap-3 pb-2">
                <a href="edit-profile.html"
                  class="px-8 py-3.5 bg-slate-900 text-white rounded-2xl text-xs font-black uppercase tracking-widest hover:bg-slate-800 transition-all shadow-xl shadow-slate-200 flex items-center gap-2">
                  <i data-lucide="settings" class="w-4 h-4"></i> Edit Profile
                </a>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Left: About Section -->
          <div class="lg:col-span-2 space-y-8">
            <div class="glass-card p-10 rounded-[2.5rem] border border-slate-100">
              <div class="flex items-center gap-3 mb-8">
                <div class="p-2.5 bg-indigo-50 text-indigo-600 rounded-2xl">
                  <i data-lucide="user-plus" class="w-6 h-6"></i>
                </div>
                <h3 class="text-xl font-black text-slate-800 tracking-tight">Professional Bio</h3>
              </div>
              <p id="profile-bio" class="text-lg font-medium text-slate-500 leading-relaxed italic">
                ...
              </p>
            </div>

          </div>

          <!-- Right: Stats & Quick Info -->
          <div class="space-y-8">
            <div
              class="glass-card p-8 rounded-[2.5rem] border border-slate-100 bg-gradient-to-br from-white to-slate-50">
              <h3
                class="text-xs font-black text-slate-400 uppercase tracking-widest mb-8 border-b border-slate-100 pb-4">
                Activity Stats</h3>

              <div class="space-y-8">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-4">
                    <div
                      class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-indigo-600 shadow-sm border border-slate-50">
                      <i data-lucide="briefcase" class="w-6 h-6"></i>
                    </div>
                    <div>
                      <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Experience</p>
                      <p id="profile-experience" class="text-sm font-black text-slate-800">...</p>
                    </div>
                  </div>
                </div>

                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-4">
                    <div
                      class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-purple-600 shadow-sm border border-slate-50">
                      <i data-lucide="clock" class="w-6 h-6"></i>
                    </div>
                    <div>
                      <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Hours Coached</p>
                      <p id="profile-hours" class="text-sm font-black text-slate-800">0 hrs</p>
                    </div>
                  </div>
                </div>

                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-4">
                    <div
                      class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-emerald-600 shadow-sm border border-slate-50">
                      <i data-lucide="zap" class="w-6 h-6"></i>
                    </div>
                    <div>
                      <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Response Time</p>
                      <p class="text-sm font-black text-slate-800">&lt; 2 hours</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: CREATE ARTICLE -->
    <section id="tab-create" class="tab-panel">
      <div class="max-w-4xl mx-auto card p-0 overflow-hidden bg-white">
        <div class="p-6 border-b border-gray-100 bg-white">
          <h2 class="text-xl font-bold text-gray-800">Create New Article</h2>
          <p class="text-sm text-gray-500">Fill in the details below to create a new article for your business
            coaching
            blog.</p>
        </div>

        <div class="p-8">
          <form id="articleForm" class="space-y-8">
            <!-- Title & Description -->
            <div class="space-y-4">
              <div class="flex items-center gap-2 border-b border-gray-100 pb-2">
                <i data-lucide="heading" class="w-5 h-5 text-indigo-600"></i>
                <h3 class="text-lg font-semibold text-gray-800">Title & Description</h3>
              </div>

              <div class="grid gap-4">
                <div>
                  <label for="articleTitle" class="block text-sm font-medium text-gray-700 mb-1">Title Tag*</label>
                  <input type="text" id="articleTitle"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    placeholder="Enter article title" required>
                </div>

                <div>
                  <label for="articleDescription" class="block text-sm font-medium text-gray-700 mb-1">Meta
                    Description*</label>
                  <textarea id="articleDescription" rows="3"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    placeholder="Enter a brief description for search engines (150-160 characters)" required></textarea>
                  <p class="text-xs text-gray-500 mt-1">This helps with SEO and appears in search results.</p>
                </div>
              </div>
            </div>

            <!-- Content Section -->
            <div class="space-y-4">
              <div class="flex items-center gap-2 border-b border-gray-100 pb-2">
                <i data-lucide="file-text" class="w-5 h-5 text-indigo-600"></i>
                <h3 class="text-lg font-semibold text-gray-800">Article Content</h3>
              </div>

              <div class="grid gap-4">
                <div>
                  <label for="articleContent" class="block text-sm font-medium text-gray-700 mb-1">Content*</label>
                  <textarea id="articleContent" rows="10"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    placeholder="Write your article content here..." required></textarea>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Featured Image</label>
                  <div
                    class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors cursor-pointer relative overflow-hidden"
                    id="imageUpload">
                    <div id="image-placeholder">
                      <i data-lucide="upload-cloud" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                      <p class="text-sm text-gray-600">Click to upload or drag and drop</p>
                      <p class="text-xs text-gray-400 mt-1">PNG, JPG, GIF up to 5MB</p>
                    </div>
                    <div id="image-preview-container"
                      class="hidden absolute inset-0 bg-white flex items-center justify-center">
                      <img id="image-preview" src="" class="max-h-full max-w-full object-contain">
                      <button type="button" id="remove-image"
                        class="absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 shadow-md">
                        <i data-lucide="x" class="w-4 h-4"></i>
                      </button>
                    </div>
                    <input type="file" id="featuredImage" accept="image/*" class="hidden">
                  </div>
                </div>
              </div>
            </div>

            <!-- SEO & Technical -->
            <div class="space-y-4">
              <div class="flex items-center gap-2 border-b border-gray-100 pb-2">
                <i data-lucide="search" class="w-5 h-5 text-indigo-600"></i>
                <h3 class="text-lg font-semibold text-gray-800">SEO & Technical Details</h3>
              </div>

              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label for="slug" class="block text-sm font-medium text-gray-700 mb-1">URL Slug*</label>
                  <input type="text" id="slug"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    placeholder="custom-url-slug" required>
                  <p class="text-xs text-gray-500 mt-1">Part of the article URL.</p>
                </div>
                <div>
                  <label for="keywords" class="block text-sm font-medium text-gray-700 mb-1">Focus Keywords</label>
                  <input type="text" id="keywords"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    placeholder="business, coaching, strategy">
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Meta Robots</label>
                <div class="space-y-2">
                  <label class="flex items-center gap-2">
                    <input type="checkbox" id="indexPage" checked
                      class="rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                    <span class="text-sm text-gray-700">Allow search engines to index this page</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" id="followLinks" checked
                      class="rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                    <span class="text-sm text-gray-700">Allow search engines to follow links on this page</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Categorization -->
            <div class="space-y-4">
              <div class="flex items-center gap-2 border-b border-gray-100 pb-2">
                <i data-lucide="tag" class="w-5 h-5 text-indigo-600"></i>
                <h3 class="text-lg font-semibold text-gray-800">Categorization</h3>
              </div>

              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category*</label>
                  <select id="category"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    required>
                    <option value="">Select a category</option>
                    <option value="business-strategy">Business Strategy</option>
                    <option value="leadership">Leadership</option>
                    <option value="marketing">Marketing</option>
                    <option value="productivity">Productivity</option>
                    <option value="career-growth">Career Growth</option>
                    <option value="entrepreneurship">Entrepreneurship</option>
                  </select>
                </div>
                <div>
                  <label for="tags" class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                  <input type="text" id="tags"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    placeholder="Add tags separated by commas">
                </div>
              </div>
              <div>
                <label class="flex items-center gap-2 mt-2">
                  <input type="checkbox" id="featured"
                    class="rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                  <span class="text-sm text-gray-700 font-medium">Mark as featured article</span>
                </label>
              </div>
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-end gap-3 pt-4 border-t border-gray-100">
              <button type="button"
                class="btn btn-outline text-gray-600 border-gray-300 hover:bg-gray-50 flex items-center gap-2">
                <i data-lucide="x" class="w-4 h-4"></i> Cancel
              </button>
              <button type="submit"
                class="btn btn-primary bg-indigo-600 hover:bg-indigo-700 text-white flex items-center gap-2 px-6">
                <i data-lucide="save" class="w-4 h-4"></i> Publish Article
              </button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- TAB: MESSAGES (Full Page Redesign) -->
    <section id="tab-messages" class="tab-panel fade-in h-[calc(100vh-12rem)]">
      <div
        class="h-full glass-card rounded-[2.5rem] border border-slate-100 overflow-hidden shadow-2xl shadow-slate-200/50 flex">
        <!-- Sidebar: Client List -->
        <div class="w-80 border-r border-slate-100 flex flex-col bg-slate-50/50 text-slate-800">
          <div class="p-6 border-b border-slate-100 bg-white/80 backdrop-blur-md sticky top-0 z-10">
            <h3 class="text-xl font-black text-slate-800 tracking-tight flex items-center gap-2">
              <i data-lucide="users" class="w-5 h-5 text-indigo-600"></i> Clients
            </h3>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Select a client to chat</p>
          </div>

          <div id="full-chat-user-list" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1">
            <!-- Populated by JS -->
            <div class="animate-pulse p-4 space-y-3 font-semibold">
              <div class="h-12 bg-slate-200 rounded-2xl w-full"></div>
              <div class="h-12 bg-slate-200 rounded-2xl w-full"></div>
            </div>
          </div>
        </div>

        <!-- Main Area: Conversation -->
        <div class="flex-1 flex flex-col bg-white relative">
          <!-- Active Header -->
          <div id="full-chat-header"
            class="p-6 border-b border-slate-100 flex items-center justify-between bg-white/80 backdrop-blur-md sticky top-0 z-10 hidden">
            <div class="flex items-center gap-4">
              <div class="relative">
                <div id="full-chat-user-avatar"
                  class="w-12 h-12 rounded-2xl bg-indigo-500 flex items-center justify-center text-white font-black text-lg shadow-lg shadow-indigo-200">
                  ?
                </div>
                <div id="full-chat-status-dot"
                  class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-white bg-slate-300 shadow-sm">
                </div>
              </div>
              <div>
                <h3 id="full-chat-user-name" class="text-lg font-black text-slate-800 tracking-tight">Active Client
                </h3>
                <p id="full-chat-status-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                  Offline</p>
              </div>
            </div>
          </div>

          <!-- Messages Container -->
          <div id="full-chat-messages" class="flex-1 overflow-y-auto p-8 space-y-6 custom-scrollbar bg-slate-50/20">
            <div id="full-chat-empty-state"
              class="h-full flex flex-col items-center justify-center text-center space-y-4">
              <div
                class="w-20 h-20 bg-indigo-50 text-indigo-200 rounded-[2rem] flex items-center justify-center shadow-inner">
                <i data-lucide="message-circle" class="w-10 h-10"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold text-slate-800">Your Communication Hub</h3>
                <p class="text-slate-500 max-w-xs mt-2 text-sm font-semibold">Select a client from the sidebar to
                  start
                  a real-time
                  conversation.</p>
              </div>
            </div>
            <!-- Messages populated here -->
          </div>

          <!-- Input Area -->
          <div id="full-chat-input-container" class="p-6 border-t border-slate-100 bg-white hidden">
            <form id="full-chat-form"
              class="flex gap-4 items-center bg-slate-50 p-3 rounded-[1.5rem] border border-slate-200 focus-within:border-indigo-300 focus-within:ring-4 focus-within:ring-indigo-500/5 transition-all">
              <input id="full-chat-input" type="text" autocomplete="off" placeholder="Type your message..."
                class="flex-1 bg-transparent border-none py-2 px-4 text-sm text-slate-800 focus:ring-0 outline-none font-medium">
              <button type="submit"
                class="p-3 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 active:scale-95">
                <i data-lucide="send-horizontal" class="w-5 h-5"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
    </section>


    <!-- TAB: SETTINGS -->
    <section id="tab-settings" class="tab-panel">
      <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm mb-8">
          <div class="p-8 border-b border-slate-100 bg-red-50/20">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-red-100 text-red-600 rounded-xl flex items-center justify-center">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold text-slate-800">Danger Zone</h3>
                <p class="text-sm text-slate-500 font-medium tracking-tight">Irreversible account actions</p>
              </div>
            </div>
          </div>

          <div class="divide-y divide-slate-100">
            <div class="p-8 flex items-center justify-between hover:bg-slate-50 transition-colors">
              <div>
                <p class="font-bold text-slate-800">Deactivate Account</p>
                <p class="text-xs text-slate-500 mt-1">Hide your profile and pause client interactions</p>
              </div>
              <button id="deactivateAccBtn"
                class="px-5 py-2.5 bg-amber-50 text-amber-600 rounded-xl text-xs font-bold hover:bg-amber-100 transition-all border border-amber-100">
                Deactivate
              </button>
            </div>

            <div class="p-8 flex items-center justify-between hover:bg-red-50/30 transition-colors">
              <div>
                <p class="font-bold text-red-600">Delete Account</p>
                <p class="text-xs text-slate-500 mt-1">Permanently remove your account and all data</p>
              </div>
              <button id="deleteAccBtn"
                class="px-5 py-2.5 bg-red-600 text-white rounded-xl text-xs font-bold hover:bg-red-700 transition-all shadow-md">
                Delete Account
              </button>
            </div>
          </div>
        </div>

        <!-- Logout button removed from here and moved to navbar -->
      </div>
    </section>

    <!-- TAB: ANNOUNCEMENTS -->
    <section id="tab-announcements" class="tab-panel hidden fade-in">
      <div class="glass-card p-8 rounded-[2rem] border border-slate-100 shadow-xl mb-10">
        <h2 class="text-3xl font-black text-slate-800 mb-2">Announce an Event</h2>
        <p class="text-slate-500 font-medium mb-8">Notify your students or the entire platform about upcoming sessions.
        </p>

        <form id="announcement-form" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-2">
              <label class="text-xs font-black text-slate-400 uppercase tracking-widest px-1">Event Title</label>
              <input type="text" id="announcement-title" required placeholder="e.g. Career Strategy Session"
                class="w-full bg-slate-50 border-2 border-slate-100 focus:border-indigo-500 rounded-2xl px-5 py-3.5 text-slate-800 font-bold transition-all outline-none">
            </div>
            <div class="space-y-2">
              <label class="text-xs font-black text-slate-400 uppercase tracking-widest px-1">Visibility</label>
              <select id="announcement-visibility"
                class="w-full bg-slate-50 border-2 border-slate-100 focus:border-indigo-500 rounded-2xl px-5 py-3.5 text-slate-800 font-bold transition-all outline-none cursor-pointer">
                <option value="private">Private (My Students Only)</option>
                <option value="public">Public (Everyone on Planexa)</option>
              </select>
            </div>
          </div>

          <div class="space-y-2">
            <label class="text-xs font-black text-slate-400 uppercase tracking-widest px-1">Event Description</label>
            <textarea id="announcement-description" rows="3" placeholder="Tell users what this event is about..."
              class="w-full bg-slate-50 border-2 border-slate-100 focus:border-indigo-500 rounded-2xl px-5 py-3.5 text-slate-800 font-medium transition-all outline-none resize-none"></textarea>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="space-y-2">
              <label class="text-xs font-black text-slate-400 uppercase tracking-widest px-1">Start Date</label>
              <input type="date" id="announcement-start-date" required
                class="w-full bg-slate-50 border-2 border-slate-100 focus:border-indigo-500 rounded-2xl px-5 py-3.5 text-slate-800 font-bold transition-all outline-none">
            </div>
            <div class="space-y-2">
              <label class="text-xs font-black text-slate-400 uppercase tracking-widest px-1">Start Time</label>
              <input type="time" id="announcement-start-time" required
                class="w-full bg-slate-50 border-2 border-slate-100 focus:border-indigo-500 rounded-2xl px-5 py-3.5 text-slate-800 font-bold transition-all outline-none">
            </div>
            <div class="space-y-2">
              <label class="text-xs font-black text-slate-400 uppercase tracking-widest px-1">End Date</label>
              <input type="date" id="announcement-end-date" required
                class="w-full bg-slate-50 border-2 border-slate-100 focus:border-indigo-500 rounded-2xl px-5 py-3.5 text-slate-800 font-bold transition-all outline-none">
            </div>
            <div class="space-y-2">
              <label class="text-xs font-black text-slate-400 uppercase tracking-widest px-1">End Time</label>
              <input type="time" id="announcement-end-time" required
                class="w-full bg-slate-50 border-2 border-slate-100 focus:border-indigo-500 rounded-2xl px-5 py-3.5 text-slate-800 font-bold transition-all outline-none">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-2">
              <label class="text-xs font-black text-slate-400 uppercase tracking-widest px-1">Timezone</label>
              <select id="announcement-timezone" required
                class="w-full bg-slate-50 border-2 border-slate-100 focus:border-indigo-500 rounded-2xl px-5 py-3.5 text-slate-800 font-bold transition-all outline-none cursor-pointer">
                <option value="Asia/Calcutta" selected>Asia/Calcutta (GMT+5:30)</option>
                <option value="UTC">UTC (GMT+0)</option>
                <option value="America/New_York">America/New_York (GMT-5:00)</option>
                <option value="Europe/London">Europe/London (GMT+0:00)</option>
              </select>
            </div>
            <div class="flex items-end">
              <button type="submit" id="post-announcement-btn"
                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-black uppercase tracking-widest py-4 rounded-2xl shadow-lg shadow-indigo-200 hover:shadow-indigo-300 transition-all active:scale-[0.98]">
                Broadcast Announcement
              </button>
            </div>
          </div>
        </form>
      </div>

      <div class="glass-card p-8 rounded-[2rem] border border-slate-100 shadow-xl">
        <h3 class="text-2xl font-black text-slate-800 mb-6">Past Announcements</h3>
        <div id="announcements-list" class="space-y-4">
          <!-- Populated by JS -->
          <div class="py-12 text-center text-slate-400 font-medium">
            <i data-lucide="history" class="w-12 h-12 mx-auto mb-4 opacity-20"></i>
            <p>Your previous announcements will appear here.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- USER PROFILE PREVIEW MODAL -->
  <div id="user-profile-modal" class="fixed inset-0 z-[100] hidden overflow-y-auto">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" id="close-profile-modal"></div>

    <div class="flex min-h-full items-center justify-center p-4">
      <div class="glass-card relative w-full max-w-2xl transform rounded-[2rem] bg-white p-8 shadow-2xl transition-all">
        <!-- Close Button -->
        <button id="close-profile-modal-btn"
          class="absolute right-6 top-6 p-2 text-slate-400 hover:text-slate-600 transition-colors">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>

        <div id="modal-content" class="space-y-8">
          <!-- Populated by JS -->
          <div class="animate-pulse space-y-6">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-slate-200 rounded-2xl"></div>
              <div class="space-y-2">
                <div class="h-6 bg-slate-200 rounded-lg w-32"></div>
                <div class="h-4 bg-slate-100 rounded-lg w-48"></div>
              </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div class="h-20 bg-slate-50 rounded-2xl"></div>
              <div class="h-20 bg-slate-50 rounded-2xl"></div>
              <div class="h-20 bg-slate-50 rounded-2xl"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // INITIALIZATION
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      initTabs();
      initCharts();
      fetchProfile();
      fetchStudents();
      fetchRequests();
      initArticleForm();
      initArticleImageUpload();

      // Chat specific listeners
      const fullChatForm = document.getElementById('full-chat-form');
      if (fullChatForm) {
        fullChatForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const input = document.getElementById('full-chat-input');
          const content = input?.value.trim();
          if (!content || !activeChatUser || !chatSocket) return;

          appendCoachMessage({
            content,
            sender_id: Number(coachInfo.id),
            sender_type: 'coach',
            created_at: new Date()
          }, 'outgoing');

          chatSocket.emit('send_message', { receiverId: Number(activeChatUser.id), content });
          if (input) input.value = '';
        });
      }

      initCoachChat();
      initAccountManagement();
      initAnnouncements();
    });

    async function initAnnouncements() {
      const form = document.getElementById('announcement-form');
      if (!form) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('post-announcement-btn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Broadcasting...';

        const data = {
          title: document.getElementById('announcement-title').value,
          visibility: document.getElementById('announcement-visibility').value,
          description: document.getElementById('announcement-description').value,
          start_datetime: `${document.getElementById('announcement-start-date').value} ${document.getElementById('announcement-start-time').value}`,
          end_datetime: `${document.getElementById('announcement-end-date').value} ${document.getElementById('announcement-end-time').value}`,
          timezone: document.getElementById('announcement-timezone').value
        };

        try {
          const res = await fetch('/api/coach/announcements', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (!res.ok) throw new Error(await res.text());

          alert('Announcement broadcasted successfully!');
          form.reset();
          fetchAnnouncements();
        } catch (err) {
          console.error(err);
          alert('Failed to post announcement. Please try again.');
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });

      // Initial load
      fetchAnnouncements();
    }

    async function fetchAnnouncements() {
      const list = document.getElementById('announcements-list');
      if (!list) return;

      try {
        const res = await fetch('/api/coach/announcements');
        const announcements = await res.json();

        if (announcements.length === 0) {
          list.innerHTML = `
            <div class="py-12 text-center text-slate-400 font-medium">
              <i data-lucide="history" class="w-12 h-12 mx-auto mb-4 opacity-20"></i>
              <p>Your previous announcements will appear here.</p>
            </div>`;
          lucide.createIcons();
          return;
        }

        list.innerHTML = announcements.map(ann => `
          <div class="p-6 bg-slate-50 border border-slate-100 rounded-2xl hover:border-indigo-200 transition-all group">
            <div class="flex justify-between items-start mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-indigo-600 shadow-sm border border-slate-100">
                  <i data-lucide="${ann.visibility === 'public' ? 'globe' : 'lock'}" class="w-5 h-5"></i>
                </div>
                <div>
                  <h4 class="font-bold text-slate-800">${ann.title}</h4>
                  <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${ann.visibility} Announcement</p>
                </div>
              </div>
              <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${new Date(ann.created_at).toLocaleDateString()}</span>
            </div>
            <p class="text-sm text-slate-600 mb-4 line-clamp-2">${ann.description || 'No description provided.'}</p>
            <div class="flex flex-wrap gap-4 pt-4 border-t border-slate-200/50">
              <div class="flex items-center gap-2 text-xs font-bold text-slate-500">
                <i data-lucide="calendar" class="w-3.5 h-3.5"></i>
                <span>Starts: ${new Date(ann.start_datetime).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' })}</span>
              </div>
              <div class="flex items-center gap-2 text-xs font-bold text-slate-500">
                <i data-lucide="clock" class="w-3.5 h-3.5"></i>
                <span>${ann.timezone}</span>
              </div>
            </div>
          </div>
        `).join('');
        lucide.createIcons();
      } catch (err) {
        console.error('Error fetching announcements:', err);
      }
    }

    function initAccountManagement() {
      const deactivateBtn = document.getElementById('deactivateAccBtn');
      const deleteBtn = document.getElementById('deleteAccBtn');

      if (deactivateBtn) {
        deactivateBtn.addEventListener('click', async () => {
          if (!confirm("Are you sure you want to deactivate your account? Your profile will be hidden and interactions will be paused. You can log back in later to reactivate.")) return;

          try {
            const res = await fetch('/api/coach/deactivate', { method: 'POST' });
            if (!res.ok) throw new Error(await res.text());
            alert("Account deactivated. You will now be logged out.");
            window.location.replace('/landing.html');
          } catch (e) {
            alert("Error: " + e.message);
          }
        });
      }

      if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
          if (!confirm("CRITICAL: Are you sure you want to DELETE your account? This action is permanent and you will not be able to log back in. Your data will be preserved for administrative purposes but your access will be revoked.")) return;

          try {
            const res = await fetch('/api/coach/delete', { method: 'POST' });
            if (!res.ok) throw new Error(await res.text());
            alert("Account deleted. Thank you for using PlannIt.");
            window.location.replace('/landing.html');
          } catch (e) {
            alert("Error: " + e.message);
          }
        });
      }
    }

    async function fetchRequests() {
      // Delegate to the correct loader
      await loadPendingRequests();
    }

    async function approveRequest(userId) {
      await respondToRequest(userId, 'approve');
    }

    async function rejectRequest(userId) {
      await respondToRequest(userId, 'reject');
    }

    async function fetchStudents() {
      try {
        const res = await fetch('/api/coach/students');
        if (!res.ok) throw new Error('Failed to fetch students');
        const students = await res.json();

        // Update Stats
        const statsHeaders = document.querySelectorAll('.stat-card h3');
        if (statsHeaders[0]) statsHeaders[0].textContent = students.length;

        // Update Grid
        const grid = document.getElementById('users-grid');
        const noClientsMsg = document.getElementById('no-clients-msg');
        const filterSelect = document.getElementById('analytics-filter');

        // Reset filter select to just "Overall"
        if (filterSelect) {
          filterSelect.innerHTML = '<option value="overall">Overall Workspace</option>';
        }

        if (students.length > 0) {
          if (noClientsMsg) noClientsMsg.style.display = 'none';

          grid.innerHTML = ''; // Clear old cards
          students.forEach(student => {
            const progress = student.totalTasks > 0 ? Math.round((student.tasksDone / student.totalTasks) * 100) : 0;
            const card = document.createElement('div');
            card.className = 'user-card fade-in flex flex-col md:flex-row md:items-center gap-6';
            card.innerHTML = `
                <div class="flex items-center gap-4 min-w-[240px] relative">
                  <div onclick="viewUserProfile(${student.id})" 
                    class="w-14 h-14 rounded-2xl bg-indigo-600 flex items-center justify-center text-white font-black text-xl shadow-lg shadow-indigo-100 shrink-0 cursor-pointer hover:bg-indigo-700 transition-all relative" 
                    title="Click to manage student">
                    ${student.username.substring(0, 1).toUpperCase()}
                    ${student.unreadCount > 0 ? `
                      <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-black rounded-full border-2 border-white flex items-center justify-center shadow-sm">
                        ${student.unreadCount}
                      </span>
                    ` : ''}
                  </div>
                  <div class="min-w-0 cursor-pointer" onclick="viewUserProfile(${student.id})" title="Click to manage student">
                    <h4 class="font-bold text-slate-800 truncate hover:text-indigo-600 transition-colors">${student.username}</h4>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter truncate">${student.email}</p>
                    <div class="mt-1 flex items-center gap-2">
                       <span class="px-1.5 py-0.5 bg-green-50 text-green-600 rounded text-[9px] font-black uppercase tracking-wider">Active</span>
                    </div>
                  </div>
                </div>

                <div class="flex-1">
                  <div class="flex justify-between items-center mb-1.5">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Task Progress</span>
                    <span class="text-xs font-black text-indigo-600">${progress}%</span>
                  </div>
                  <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                    <div class="bg-indigo-600 h-full rounded-full transition-all duration-1000 shadow-[0_0_12px_rgba(99,102,241,0.4)]" style="width: ${progress}%"></div>
                  </div>
                </div>

                <div class="flex items-center gap-8 px-4">
                  <div class="text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Goals</p>
                    <p class="text-base font-black text-slate-800 leading-tight">${student.totalGoals || 0}</p>
                  </div>
                  <div class="text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Tasks</p>
                    <p class="text-base font-black text-slate-800 leading-tight">${student.tasksDone || 0}</p>
                  </div>
                </div>

                <div class="flex gap-2 shrink-0">
                  <button onclick="openChatWithStudent(${student.id}, '${student.username}')" 
                    class="p-3 bg-indigo-50 text-indigo-600 rounded-2xl hover:bg-indigo-100 transition-colors" title="Message">
                    <i data-lucide="message-square" class="w-5 h-5"></i>
                  </button>
                  <button onclick="viewStudentDetails(${student.id})" 
                    class="px-6 py-3 bg-slate-900 text-white rounded-2xl text-xs font-black uppercase tracking-wider hover:bg-black transition-all shadow-lg shadow-slate-200">
                    Analytics
                  </button>
                </div>
            `;
            grid.appendChild(card);

            // Add to dropdown
            if (filterSelect) {
              const opt = document.createElement('option');
              opt.value = student.id;
              opt.textContent = student.username;
              filterSelect.appendChild(opt);
            }
          });
        } else {
          if (noClientsMsg) noClientsMsg.style.display = 'flex';
          grid.innerHTML = '';
        }

        lucide.createIcons();

        // Update Total Message Count
        const totalUnread = (students || []).reduce((sum, s) => sum + (Number(s.unreadCount) || 0), 0);
        const totalBadge = document.getElementById('total-messages-count');
        if (totalBadge) {
          totalBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
          if (totalUnread > 0) totalBadge.classList.remove('hidden');
          else totalBadge.classList.add('hidden');
        }

        // Show FAB only if there are active students
        const coachChatFab = document.getElementById('coach-chat-fab');
        if (coachChatFab) {
          if (students.length > 0) {
            coachChatFab.classList.remove('hidden');
          } else {
            coachChatFab.classList.add('hidden');
          }
        }
      } catch (err) {
        console.error('Fetch students error:', err);
      }
    }

    let studentChart = null;
    let studentGoalChart = null;

    function viewStudentDetails(studentId) {
      // Switch to Analytics Tab
      const analyticsBtn = document.querySelector('[data-tab="analytics"]');
      if (analyticsBtn) analyticsBtn.click();

      // Set filter and trigger change
      const filter = document.getElementById('analytics-filter');
      if (filter) {
        filter.value = studentId;
        handleAnalyticsFilterChange();
      }
    }

    // USER PROFILE VIEW MODAL LOGIC
    async function viewUserProfile(userId) {
      const modal = document.getElementById('user-profile-modal');
      const content = document.getElementById('modal-content');
      if (!modal || !content) return;

      // Show modal with loading state
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      try {
        const res = await fetch(`/api/coach/user-profile/${userId}`);
        if (!res.ok) throw new Error('Failed to load profile');
        const data = await res.json();

        const student = data.user;
        const booking = data.booking || {};
        const stats = data.stats || {};
        const photoUrl = booking.user_photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(student.username)}&background=6366f1&color=fff`;

        content.innerHTML = `
          <div class="flex flex-col md:flex-row items-center gap-6 pb-6 border-b border-slate-100">
            <img src="${photoUrl}" class="w-20 h-20 rounded-[2rem] object-cover shadow-xl shadow-indigo-100">
            <div class="text-center md:text-left">
              <h3 class="text-2xl font-black text-slate-800">${booking.user_name_input || student.username}</h3>
              <p class="text-sm font-bold text-slate-400 uppercase tracking-widest">${student.email}</p>
              <div class="mt-2 flex flex-wrap justify-center md:justify-start gap-2">
                <span class="px-2 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-black uppercase tracking-wider">${booking.booking_category || 'General'}</span>
                <span class="px-2 py-1 bg-orange-50 text-orange-600 rounded-lg text-[10px] font-black uppercase tracking-wider">${booking.session_type || 'One-time Session'}</span>
              </div>
            </div>
          </div>

          <div class="space-y-4">
            <h4 class="text-sm font-black text-slate-800 uppercase tracking-widest">Coaching Message</h4>
            <div class="p-6 bg-indigo-50/50 rounded-3xl border border-indigo-100/50 italic text-slate-600 text-sm leading-relaxed">
              "${booking.booking_goal || 'No message provided.'}"
            </div>
          </div>

          <div class="flex items-center justify-between pt-6 border-t border-slate-100">
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
              Requested for: <span class="text-slate-800 ml-1 font-black">${booking.requested_time || 'Flexible'}</span>
            </div>
            <div class="flex gap-2">
              <button onclick="closeProfileModal()" class="px-6 py-3 text-slate-400 text-xs font-black uppercase tracking-wider hover:text-slate-600 transition-all">Close</button>
              <button onclick="approveFromModal(${student.id})" class="px-8 py-3 bg-slate-900 text-white rounded-2xl text-xs font-black uppercase tracking-wider hover:bg-slate-800 transition-all shadow-lg shadow-indigo-100">Approve Request</button>
            </div>
          </div>
        `;
        lucide.createIcons();
      } catch (err) {
        content.innerHTML = `
          <div class="flex flex-col items-center justify-center p-12 text-center text-red-500">
            <i data-lucide="alert-circle" class="w-12 h-12 mb-4"></i>
            <p class="font-bold">Error loading user profile</p>
            <p class="text-xs mt-1 text-slate-400">${err.message}</p>
          </div>
        `;
        lucide.createIcons();
      }
    }

    function closeProfileModal() {
      const modal = document.getElementById('user-profile-modal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }

    async function approveFromModal(userId) {
      closeProfileModal();
      await approveRequest(userId);
    }

    // Modal listeners
    document.getElementById('close-profile-modal')?.addEventListener('click', closeProfileModal);
    document.getElementById('close-profile-modal-btn')?.addEventListener('click', closeProfileModal);
    function openChatWithStudent(id, name) {
      // Switch to Messages Tab
      const messageTabBtn = document.querySelector('[data-tab="messages"]');
      if (messageTabBtn) {
        messageTabBtn.click();
      }

      // Select the specific student in chat
      selectChatUser({ id, username: name });
    }

    // ARTICLE FORM LOGIC
    function initArticleForm() {
      const form = document.getElementById('articleForm');
      if (!form) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="animate-spin" data-lucide="loader"></i> Publishing...';
        lucide.createIcons();

        const imgPreview = document.getElementById('image-preview');
        const imageUrl = imgPreview && imgPreview.src.startsWith('data:') ? imgPreview.src : null;

        // Basic data collection
        const data = {
          title: document.getElementById('articleTitle').value,
          description: document.getElementById('articleDescription').value,
          content: document.getElementById('articleContent').value,
          slug: document.getElementById('slug').value,
          category: document.getElementById('category').value,
          imageUrl: imageUrl || `https://source.unsplash.com/random/800x600/?${document.getElementById('category').value}`,
          status: 'published' // Auto-publish for now
        };

        try {
          const res = await fetch('/api/articles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Failed to publish');
          }

          const result = await res.json();
          alert('Article published successfully!');
          const removeBtn = document.getElementById('remove-image');
          if (removeBtn) removeBtn.click();
          form.reset();
        } catch (err) {
          console.error(err);
          alert('Error: ' + err.message);
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
          lucide.createIcons();
        }
      });
    }

    function initArticleImageUpload() {
      const dropZone = document.getElementById('imageUpload');
      const fileInput = document.getElementById('featuredImage');
      const placeholder = document.getElementById('image-placeholder');
      const previewContainer = document.getElementById('image-preview-container');
      const previewImg = document.getElementById('image-preview');
      const removeBtn = document.getElementById('remove-image');

      if (!dropZone || !fileInput) return;

      dropZone.addEventListener('click', (e) => {
        if (e.target.closest('#remove-image')) return;
        fileInput.click();
      });

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleImageFile(file);
      });

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('bg-indigo-50', 'border-indigo-400');
      });

      ['dragleave', 'drop'].forEach(name => {
        dropZone.addEventListener(name, () => {
          dropZone.classList.remove('bg-indigo-50', 'border-indigo-400');
        });
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          handleImageFile(file);
        }
      });

      removeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        fileInput.value = '';
        previewImg.src = '';
        previewContainer.classList.add('hidden');
        placeholder.classList.remove('hidden');
      });

      function handleImageFile(file) {
        if (file.size > 5 * 1024 * 1024) {
          alert('Image too large. Max 5MB.');
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          placeholder.classList.add('hidden');
          previewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    }

    // CLIENT VIEW LOGIC
    function viewClient(name, imgSrc) {
      // Hide all main tab panels
      document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
      // Hide Tabs Nav to focus on client view (optional, but cleaner)
      // document.getElementById('tabs').style.display = 'none'; 

      // Show Detail View
      const view = document.getElementById('client-detail-view');
      view.classList.remove('hidden');

      // Populate Data
      document.getElementById('detail-client-name').textContent = name;
      if (imgSrc) document.getElementById('detail-client-img').src = imgSrc;

      // Re-run icons for new content if needed (though static here)
      lucide.createIcons();
    }

    function closeClientView() {
      // Hide Detail View
      document.getElementById('client-detail-view').classList.add('hidden');

      // Show Active Tab (Users by default or last active)
      // Simplest: Just trigger click on active tab button
      const activeBtn = document.querySelector('.tab-btn.active');
      if (activeBtn) {
        // Restore display check handled by initTabs click logic? 
        // Actually our initTabs toggles class 'active', but we manually set style.display='none' above.
        // Let's reset styles:
        document.querySelectorAll('.tab-panel').forEach(p => p.style.display = '');
        // Display the active one
        document.querySelectorAll('.tab-panel').forEach(p => {
          p.classList.remove('active'); // reset
        });
        const targetId = `tab-${activeBtn.dataset.tab}`;
        document.getElementById(targetId).classList.add('active');
      }
    }

    // AUTH CHECK - Removed inline checkAuth as auth-helper.js now handles this globally.

    // TAB LOGIC matching app.html
    function initTabs() {
      const btns = document.querySelectorAll('.tab-btn, .dropdown-item[data-tab]');
      const panels = document.querySelectorAll('.tab-panel');

      const updateVisibility = (targetId) => {
        panels.forEach(p => {
          if (p.id === `tab-${targetId}`) {
            p.style.display = 'block';
            p.classList.add('active');
          } else {
            p.style.display = 'none';
            p.classList.remove('active');
          }
        });
      };

      btns.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.tab;
          if (!target) return;

          // Update Active States for Navbar Buttons (not dropdown items)
          if (btn.classList.contains('tab-btn')) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          } else {
            // If from dropdown, remove active from all navbar buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          }

          updateVisibility(target);
          if (target === 'messages') {
            initCoachChat();
          }

          // Close dropdown if it was a dropdown item
          if (btn.classList.contains('dropdown-item')) {
            document.getElementById('coach-profile-dropdown')?.classList.remove('show');
            document.getElementById('nav-profile-chevron')?.classList.remove('rotate-180');
          }
        });
      });

      // Dropdown Toggle Logic
      const profileBtn = document.getElementById('coach-profile-btn');
      const profileDropdown = document.getElementById('coach-profile-dropdown');
      const profileChevron = document.getElementById('nav-profile-chevron');

      if (profileBtn && profileDropdown) {
        profileBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          profileDropdown.classList.toggle('show');
          profileChevron?.classList.toggle('rotate-180');
        });

        document.addEventListener('click', (e) => {
          if (!profileDropdown.contains(e.target) && !profileBtn.contains(e.target)) {
            profileDropdown.classList.remove('show');
            profileChevron?.classList.remove('rotate-180');
          }
        });
      }

      // Initialize state based on active button
      const activeBtn = document.querySelector('.tab-btn.active');
      if (activeBtn) {
        updateVisibility(activeBtn.dataset.tab);
      }
    }

    // PROFILE FETCH
    async function fetchProfile() {
      try {
        const res = await fetch('/api/coach/me', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to fetch profile');
        const data = await res.json();

        // Status-based logic
        if (data.status === 'pending_onboarding') {
          window.location.replace('onboarding.html');
          return;
        }

        if (data.status === 'pending') {
          // Show overlay or message? 
          // For now, let's just add a notice bar at the top
          const notice = document.createElement('div');
          notice.className = 'bg-yellow-100 border-b border-yellow-200 text-yellow-800 px-4 py-2 text-center text-sm font-medium';
          notice.innerHTML = '<i class="fas fa-clock mr-2"></i> Your profile is currently pending admin approval. Some features may be limited.';
          document.body.prepend(notice);
        }

        document.getElementById('profile-name').textContent = data.name || data.email;

        // Update Navbar Avatar
        const navImgContainer = document.getElementById('nav-profile-img-container');
        if (navImgContainer) {
          const photoUrl = data.profile_photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.name || 'C')}&background=6366f1&color=fff`;
          navImgContainer.innerHTML = `<img src="${photoUrl}" class="w-full h-full object-cover">`;
        }

        document.getElementById('profile-email').textContent = data.email;
        document.getElementById('profile-bio').textContent = data.bio || 'Professional Coach';
        document.getElementById('profile-category').textContent = data.coach_type || 'General';
        document.getElementById('profile-experience').textContent = data.years_experience ? `${data.years_experience} Years` : 'Not specified';
        document.getElementById('profile-hours').textContent = data.hours_coached ? `${Number(data.hours_coached).toLocaleString()} hrs` : '0 hrs';

        if (data.profile_photo) {
          document.getElementById('profile-img').src = data.profile_photo;
        } else {
          document.getElementById('profile-img').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(data.name || 'Coach')}&background=random`;
        }

        // Update coachInfo if missing (for chat identification)
        if (!coachInfo || !coachInfo.id) {
          coachInfo = data;
          if (chatSocket && chatSocket.connected) {
            const idToIdentify = coachInfo.id || coachInfo.userId;
            chatSocket.emit('identify', { coachId: idToIdentify, userType: 'coach' });
          }
        }
      } catch (e) {
        console.error(e);
        window.location.replace('../../coach-login.html');
      }
    }

    // LOGOUT
    document.getElementById('logoutBtn').addEventListener('click', () => {
      AuthHelper.logout();
    });

    // CHARTS (Real Data)
    async function initCharts() {
      // Defaults to match app style
      Chart.defaults.font.family = "'Inter', system-ui, sans-serif";
      Chart.defaults.font.weight = '700';
      Chart.defaults.color = '#94a3b8';

      try {
        const res = await fetch('/api/coach/analytics');
        if (!res.ok) throw new Error('Failed to fetch coach analytics');
        const data = await res.json();

        const actCtx = document.getElementById('activityChart')?.getContext('2d');
        if (actCtx) {
          const labels = data.performance.map(p => p.month);

          new Chart(actCtx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Tasks Completed',
                data: data.performance.map(p => p.count),
                backgroundColor: '#6366f1',
                borderRadius: 8,
                barThickness: 24
              },
              {
                label: 'Goals Active',
                data: data.goalPerformance ? data.goalPerformance.map(p => p.count) : [],
                backgroundColor: '#10b981',
                borderRadius: 8,
                barThickness: 24
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  align: 'end',
                  labels: {
                    boxWidth: 8,
                    boxHeight: 8,
                    usePointStyle: true,
                    pointStyle: 'circle',
                    padding: 20,
                    font: { size: 11, weight: 'bold' }
                  }
                },
                tooltip: {
                  backgroundColor: '#1e293b',
                  padding: 12,
                  cornerRadius: 12,
                  titleFont: { size: 12, weight: '900' },
                  bodyFont: { size: 12, weight: 'bold' }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: '#f8fafc', drawBorder: false },
                  ticks: { font: { weight: 'bold' } }
                },
                x: {
                  grid: { display: false },
                  ticks: { font: { weight: 'bold' } }
                }
              }
            }
          });
        }

        const growthCtx = document.getElementById('growthChart')?.getContext('2d');
        if (growthCtx) {
          new Chart(growthCtx, {
            type: 'line',
            data: {
              labels: data.growth.map(g => g.month),
              datasets: [{
                label: 'New Clients',
                data: data.growth.map(g => g.count),
                borderColor: '#10b981',
                borderWidth: 4,
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(16, 185, 129, 0.05)',
                pointBackgroundColor: '#fff',
                pointBorderColor: '#10b981',
                pointBorderWidth: 3,
                pointRadius: 5
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: '#1e293b',
                  padding: 12,
                  cornerRadius: 12
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: '#f8fafc', drawBorder: false },
                  ticks: { font: { weight: 'bold' } }
                },
                x: {
                  grid: { display: false },
                  ticks: { font: { weight: 'bold' } }
                }
              }
            }
          });
        }
      } catch (err) {
        console.error('Error initializing charts:', err);
      }
    }

    /* ---------------- COACH CHAT LOGIC ---------------- */
    // Article Image Validation
    const featuredImageInput = document.getElementById('featuredImage');
    const articleImagePreview = document.getElementById('articleImagePreview');
    const articleImageValue = document.getElementById('articleImageValue');
    const uploadPlaceholder = document.querySelector('.upload-placeholder');

    if (featuredImageInput) {
      featuredImageInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 500 * 1024) {
            alert("Image must be less than 500KB.");
            this.value = '';
            return;
          }
          const reader = new FileReader();
          reader.onload = function (event) {
            if (articleImagePreview) {
              articleImagePreview.innerHTML = `<img src="${event.target.result}" alt="Preview" class="w-full h-full object-cover">`;
              articleImagePreview.classList.remove('hidden');
            }
            if (uploadPlaceholder) uploadPlaceholder.classList.add('hidden');
            if (articleImageValue) articleImageValue.value = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
    }

    let chatSocket;
    let activeChatUser = null;
    let coachInfo = JSON.parse(localStorage.getItem('planner.user') || '{}');
    if (coachInfo.user) coachInfo = coachInfo.user;

    function getBackendUrl() {
      const { hostname, port } = window.location;
      if (hostname === 'localhost' || hostname === '127.0.0.1' || port === '3000' || port === '5500' || port === '5501') {
        return `http://${hostname}:3000`;
      }
      return '';
    }

    async function initCoachChat() {
      if (chatSocket) {
        loadChatUsers(); // Refresh on tab click
        return;
      }
      chatSocket = io(getBackendUrl(), { withCredentials: true });

      chatSocket.on('connect', () => {
        const idToIdentify = Number(coachInfo.id || coachInfo.userId);
        if (idToIdentify) {
          chatSocket.emit('identify', { coachId: idToIdentify, userType: 'coach' });
        }
        loadChatUsers();
      });

      chatSocket.on('new_message', (msg) => {
        if (activeChatUser && Number(msg.sender_id) === Number(activeChatUser.id) && msg.sender_type === 'user') {
          appendCoachMessage(msg, 'incoming');
        } else {
          loadChatUsers();
          // Optional: Add notification indicator to tab?
        }
      });
    }

    async function loadChatUsers() {
      try {
        const res = await fetch(getBackendUrl() + '/api/coach/students');
        const students = await res.json();
        const list = document.getElementById('full-chat-user-list');
        if (!list) return;
        list.innerHTML = '';

        if (students.length === 0) {
          list.innerHTML = `
            <div class="flex flex-col items-center justify-center p-8 text-center opacity-50 space-y-2">
              <i data-lucide="ghost" class="w-8 h-8 text-slate-300"></i>
              <p class="text-[10px] font-black uppercase text-slate-400">No students yet</p>
            </div>`;
          lucide.createIcons();
          return;
        }

        students.forEach(student => {
          const isActive = activeChatUser?.id === student.id;
          const div = document.createElement('div');
          div.className = `p-4 flex items-center gap-4 cursor-pointer transition-all rounded-2xl group ${isActive
            ? 'bg-white shadow-xl shadow-indigo-100/50 border border-slate-100'
            : 'hover:bg-white/60'}`;

          div.innerHTML = `
            <div class="w-12 h-12 rounded-2xl ${isActive ? 'bg-indigo-600 text-white' : 'bg-indigo-50 text-indigo-600'} flex items-center justify-center font-black text-lg shadow-sm transition-colors relative">
              ${student.username.charAt(0).toUpperCase()}
              ${student.unreadCount > 0 ? `
                <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-black rounded-full border-2 border-white flex items-center justify-center shadow-sm">
                  ${student.unreadCount}
                </span>
              ` : ''}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-start mb-0.5">
                <h4 class="font-black text-slate-800 truncate text-sm tracking-tight">${student.username}</h4>
                <span class="text-[9px] font-bold text-slate-400 uppercase">Active</span>
              </div>
              <p class="text-[10px] font-bold text-slate-400 truncate tracking-tight uppercase">Platform User</p>
            </div>
            <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 transition-transform"></i>
          `;
          div.onclick = () => selectChatUser(student);
          list.appendChild(div);
        });
        lucide.createIcons();
        updateTotalUnreadBadge(students);
      } catch (e) { console.error(e); }
    }

    function updateTotalUnreadBadge(students) {
      const totalUnread = (students || []).reduce((sum, s) => sum + (Number(s.unreadCount) || 0), 0);
      const totalBadge = document.getElementById('total-messages-count');
      if (totalBadge) {
        totalBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
        if (totalUnread > 0) totalBadge.classList.remove('hidden');
        else totalBadge.classList.add('hidden');
      }
    }

    async function selectChatUser(user) {
      activeChatUser = user;

      // UI Transitions
      document.getElementById('full-chat-empty-state')?.classList.add('hidden');
      document.getElementById('full-chat-header')?.classList.remove('hidden');
      document.getElementById('full-chat-input-container')?.classList.remove('hidden');

      const nameEl = document.getElementById('full-chat-user-name');
      if (nameEl) nameEl.textContent = user.username;

      const avatarEl = document.getElementById('full-chat-user-avatar');
      if (avatarEl) avatarEl.textContent = user.username.charAt(0).toUpperCase();

      const statusEl = document.getElementById('full-chat-status-dot');
      if (statusEl) statusEl.className = 'absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-white bg-green-500 shadow-sm';

      const statusText = document.getElementById('full-chat-status-text');
      if (statusText) statusText.textContent = 'Online & Active';

      loadChatUsers(); // Refresh sidebar to show active state

      try {
        const res = await fetch(getBackendUrl() + `/api/messages/${user.id}`);
        const messages = await res.json();
        const msgContainer = document.getElementById('full-chat-messages');
        if (msgContainer) {
          msgContainer.innerHTML = '';
          if (messages.length === 0) {
            msgContainer.innerHTML = `
              <div class="flex flex-col items-center justify-center h-full text-center space-y-3 opacity-40">
                <i data-lucide="message-square-dashed" class="w-8 h-8 text-slate-300"></i>
                <p class="text-xs font-bold text-slate-800 uppercase tracking-widest">No conversation history</p>
              </div>`;
            lucide.createIcons();
          } else {
            messages.forEach(msg => {
              const myId = Number(coachInfo.id);
              const type = (Number(msg.sender_id) === myId && msg.sender_type === 'coach') ? 'outgoing' : 'incoming';
              appendCoachMessage(msg, type);
            });
          }
          msgContainer.scrollTop = msgContainer.scrollHeight;
        }
      } catch (e) { console.error(e); }
    }

    function appendCoachMessage(msg, type) {
      const msgContainer = document.getElementById('full-chat-messages');
      if (!msgContainer) return;

      // Remove empty state if present
      const emptyMsg = msgContainer.querySelector('.opacity-40');
      if (emptyMsg) emptyMsg.remove();

      const div = document.createElement('div');
      div.className = `flex ${type === 'outgoing' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2 duration-300`;
      const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      div.innerHTML = `
        <div class="max-w-[70%] flex flex-col ${type === 'outgoing' ? 'items-end' : 'items-start'}">
          <div class="px-6 py-4 rounded-[1.8rem] text-sm shadow-sm font-semibold tracking-tight ${type === 'outgoing'
          ? 'bg-gradient-to-br from-indigo-600 to-purple-600 text-white rounded-tr-none shadow-xl shadow-indigo-100'
          : 'bg-white text-slate-700 border border-slate-100 rounded-tl-none'
        }">
            ${msg.content}
          </div>
          <div class="flex items-center gap-1.5 mt-2 px-1 text-[9px] font-black text-slate-400 uppercase tracking-widest">
            <span>${time}</span>
            ${type === 'outgoing' ? '<i data-lucide="check-check" class="w-2.5 h-2.5 text-indigo-400"></i>' : ''}
          </div>
        </div>
      `;
      msgContainer.appendChild(div);
      msgContainer.scrollTop = msgContainer.scrollHeight;
      lucide.createIcons();
    }
    /* ---------------- APPROVALS LOGIC ---------------- */
    async function loadPendingRequests() {
      const list = document.getElementById('approvals-list');
      const emptyMsg = document.getElementById('approvals-empty');
      const countBadge = document.getElementById('approval-count');

      if (!list) return;

      try {
        const res = await fetch('/api/coach/pending-requests');
        if (!res.ok) throw new Error('Failed to fetch requests');
        const requests = await res.json();

        // Update badge
        if (countBadge) {
          countBadge.textContent = Array.isArray(requests) ? requests.length : 0;
          if (Array.isArray(requests) && requests.length > 0) countBadge.classList.remove('hidden');
          else countBadge.classList.add('hidden');
        }

        if (!Array.isArray(requests) || requests.length === 0) {
          list.innerHTML = `
            <div class="flex flex-col items-center justify-center p-8 text-center opacity-50 space-y-2">
              <i data-lucide="ghost" class="w-8 h-8 text-slate-300"></i>
              <p class="text-[10px] font-black uppercase text-slate-400">No pending requests</p>
            </div>`;
          lucide.createIcons();
          if (emptyMsg) emptyMsg.classList.remove('hidden');
          return;
        }

        if (emptyMsg) emptyMsg.classList.add('hidden');
        list.innerHTML = '';

        requests.forEach(req => {
          const card = document.createElement('div');
          card.className = 'glass-card p-6 rounded-[1.5rem] border border-slate-100 flex flex-col gap-6 fade-in';

          const reqDate = req.requested_time ? new Date(req.requested_time).toLocaleString() : 'Flexible';
          const userPhoto = req.user_photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(req.user_name_input || req.username)}&background=random`;

          card.innerHTML = `
            <div class="flex flex-col md:flex-row gap-6">
              <!-- User Info -->
              <div class="flex items-start gap-4 min-w-[200px]">
                <img src="${userPhoto}" class="w-16 h-16 rounded-2xl object-cover shadow-sm border-2 border-white bg-slate-100">
                <div>
                  <h4 class="font-black text-slate-800 text-lg">${req.user_name_input || req.username}</h4>
                  <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">${req.email}</p>
                  <div class="inline-flex items-center px-2 py-1 rounded-lg bg-indigo-50 text-indigo-700 text-[10px] font-black uppercase tracking-widest">
                    ${req.booking_category || 'General'}
                  </div>
                </div>
              </div>

              <!-- Booking Message -->
              <div class="flex-1 space-y-3">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                  <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Their Message</p>
                  <p class="text-sm text-slate-700 leading-relaxed font-medium">"${req.booking_goal || 'No message provided'}"</p>
                </div>
                <div class="flex flex-wrap gap-4">
                  <div class="flex items-center gap-2 text-slate-500 text-xs font-bold">
                    <i data-lucide="layout" class="w-4 h-4 text-indigo-400"></i>
                    <span>${req.session_type || '1:1 Session'}</span>
                  </div>
                  <div class="flex items-center gap-2 text-slate-500 text-xs font-bold">
                    <i data-lucide="calendar" class="w-4 h-4 text-indigo-400"></i>
                    <span>${reqDate}</span>
                  </div>
                  <div class="flex items-center gap-2 text-slate-500 text-xs font-bold">
                    <i data-lucide="globe" class="w-4 h-4 text-purple-400"></i>
                    <span>${req.user_timezone || 'UTC'}</span>
                  </div>
                </div>
              </div>

              <!-- Actions -->
              <div class="flex flex-col gap-2 min-w-[140px] justify-center">
                <button onclick="respondToRequest(${req.user_id}, 'approve')" 
                  class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-xs font-black uppercase tracking-widest transition-all shadow-lg shadow-indigo-200 flex items-center justify-center gap-2">
                  <i data-lucide="check-circle" class="w-4 h-4"></i> Approve
                </button>
                <button onclick="respondToRequest(${req.user_id}, 'reject')" 
                  class="w-full py-3 bg-white border border-slate-200 text-slate-400 hover:text-red-500 hover:border-red-200 rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2">
                  <i data-lucide="x-circle" class="w-4 h-4"></i> Decline
                </button>
              </div>
            </div>
          `;
          list.appendChild(card);
        });
        lucide.createIcons();

      } catch (e) {
        console.error("Error loading requests:", e);
      }
    }

    // View User Profile Modal
    async function viewUserProfile(userId) {
      try {
        const res = await fetch(`/api/coach/user-profile/${userId}`);
        if (!res.ok) throw new Error('Failed to load profile');
        const data = await res.json();

        const { user } = data;
        const booking = data.booking || {};
        const userPhoto = booking.user_photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(booking.user_name_input || user.username)}&background=6366f1&color=fff&size=128`;
        const memberSince = new Date(user.created_at).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        // Create modal
        const existingModal = document.getElementById('userProfileModal');
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = 'userProfileModal';
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center';
        modal.innerHTML = `
          <!-- Backdrop -->
          <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeUserProfileModal()"></div>
          
          <!-- Modal -->
          <div class="relative z-10 bg-white rounded-[2rem] shadow-2xl border border-slate-100 w-full max-w-2xl max-h-[90vh] overflow-y-auto mx-4">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 rounded-t-[2rem] relative">
              <button onclick="closeUserProfileModal()" class="absolute top-4 right-4 text-white/60 hover:text-white transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
              </button>
              <div class="flex items-center gap-6">
                <img src="${userPhoto}" class="w-20 h-20 rounded-2xl object-cover border-4 border-white/30 shadow-lg">
                <div>
                  <h2 class="text-2xl font-black text-white">${booking.user_name_input || user.username}</h2>
                  <p class="text-indigo-200 text-sm font-bold">${user.email}</p>
                  <p class="text-indigo-300 text-xs font-bold mt-1">Member since ${memberSince}</p>
                </div>
              </div>
            </div>


            <!-- Student Management Section -->
            <div class="p-8 bg-slate-50/50">
              <div class="bg-white rounded-[2.5rem] border border-slate-200/60 shadow-sm overflow-hidden p-8">
                <div class="flex items-center gap-3 mb-6">
                  <div class="p-2 bg-indigo-50 text-indigo-600 rounded-xl">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <h3 class="text-xl font-black text-slate-800 tracking-tight">Assign Items</h3>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Send new tasks or goals to this student</p>
                  </div>
                </div>

                <!-- Assignment Type Tabs (Modern Pill Style) -->
                <div class="flex p-1 bg-slate-100 rounded-2xl mb-8">
                  <button onclick="switchAssignTab('todo', ${userId})" id="assign-tab-todo"
                    class="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-xs font-black uppercase tracking-wider bg-white text-indigo-600 shadow-sm transition-all border border-slate-200/50">
                    <i data-lucide="check-square" class="w-4 h-4"></i> Task
                  </button>
                  <button onclick="switchAssignTab('goal', ${userId})" id="assign-tab-goal"
                    class="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-xs font-black uppercase tracking-wider text-slate-500 hover:text-slate-800 transition-all">
                    <i data-lucide="target" class="w-4 h-4"></i> Goal
                  </button>
                  <button onclick="switchAssignTab('reminder', ${userId})" id="assign-tab-reminder"
                    class="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-xs font-black uppercase tracking-wider text-slate-500 hover:text-slate-800 transition-all">
                    <i data-lucide="bell" class="w-4 h-4"></i> Reminder
                  </button>
                </div>

                <!-- Form Panels -->
                <div class="space-y-6">
                  <!-- Task Form -->
                  <div id="assign-panel-todo" class="space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300">
                    <div class="space-y-1.5">
                      <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">Task Details</label>
                      <input id="assign-todo-text" type="text" placeholder="What needs to be done?" 
                        class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 text-base font-bold text-slate-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all placeholder:text-slate-300">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <div class="space-y-1.5">
                        <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">Priority</label>
                        <select id="assign-todo-priority" class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 text-base font-bold text-slate-600 focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-50 transition-all">
                          <option value="important">Important</option>
                          <option value="not_important">Normal</option>
                        </select>
                      </div>
                      <div class="space-y-1.5">
                        <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">Urgency</label>
                        <select id="assign-todo-urgent" class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 text-base font-bold text-slate-600 focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-50 transition-all">
                          <option value="urgent">Urgent</option>
                          <option value="not_urgent">Not Urgent</option>
                        </select>
                      </div>
                    </div>
                    <button onclick="assignToStudent('todo', ${userId})"
                      class="w-full py-5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-[1.5rem] text-xs font-black uppercase tracking-widest transition-all shadow-xl shadow-indigo-100 flex items-center justify-center gap-2 group">
                      <i data-lucide="plus" class="w-5 h-5 transition-transform group-hover:rotate-90"></i> Assign Task
                    </button>
                  </div>

                  <!-- Goal Form -->
                  <div id="assign-panel-goal" class="space-y-4 hidden h-full animate-in fade-in slide-in-from-bottom-2 duration-300">
                    <div class="space-y-1.5">
                      <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">Goal Objective</label>
                      <input id="assign-goal-text" type="text" placeholder="Set a big milestone..." 
                        class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 text-base font-bold text-slate-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all placeholder:text-slate-300">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <div class="space-y-1.5">
                        <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">Category</label>
                        <select id="assign-goal-category" class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 text-base font-bold text-slate-600 focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-50 transition-all">
                          <option value="Personal">Personal</option>
                          <option value="Career">Career</option>
                          <option value="Health">Health</option>
                          <option value="Financial">Financial</option>
                          <option value="Academic">Academic</option>
                          <option value="Work">Work</option>
                        </select>
                      </div>
                      <div class="space-y-1.5">
                        <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">Target Hours</label>
                        <input id="assign-goal-total" type="number" placeholder="e.g. 10" min="0"
                          class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 text-base font-bold text-slate-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all">
                      </div>
                    </div>
                    <button onclick="assignToStudent('goal', ${userId})"
                      class="w-full py-5 bg-purple-600 hover:bg-purple-700 text-white rounded-[1.5rem] text-xs font-black uppercase tracking-widest transition-all shadow-xl shadow-purple-100 flex items-center justify-center gap-2 group">
                      <i data-lucide="target" class="w-5 h-5 transition-transform group-hover:scale-110"></i> Assign Goal
                    </button>
                  </div>

                  <!-- Reminder Form -->
                  <div id="assign-panel-reminder" class="space-y-4 hidden animate-in fade-in slide-in-from-bottom-2 duration-300">
                    <div class="space-y-1.5">
                      <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">Reminder Title</label>
                      <input id="assign-reminder-title" type="text" placeholder="Don't forget to..." 
                        class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 text-base font-bold text-slate-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all placeholder:text-slate-300">
                    </div>
                    <div class="space-y-1.5">
                      <label class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">Scheduled Date & Time</label>
                      <input id="assign-reminder-when" type="datetime-local"
                        class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 text-base font-bold text-slate-600 focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all">
                    </div>
                    <button onclick="assignToStudent('reminder', ${userId})"
                      class="w-full py-5 bg-orange-600 hover:bg-orange-700 text-white rounded-[1.5rem] text-xs font-black uppercase tracking-widest transition-all shadow-xl shadow-orange-100 flex items-center justify-center gap-2 group">
                      <i data-lucide="bell" class="w-5 h-5 transition-transform group-hover:animate-shake"></i> Set Reminder
                    </button>
                  </div>
                </div>

                <!-- Feedback area -->
                <div id="assign-feedback" class="mt-8 text-xs font-black text-center hidden"></div>
              </div>
            </div>

            <!-- Modal Footer -->
            <div class="px-8 py-6 flex justify-center">
              <button onclick="closeUserProfileModal()" 
                class="px-12 py-4 bg-slate-900 text-white rounded-[1.8rem] text-[10px] font-black uppercase tracking-widest transition-all hover:bg-black shadow-lg shadow-slate-200">
                Done & Close
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
        lucide.createIcons();

      } catch (e) {
        console.error("Error loading profile:", e);
        alert('Failed to load user profile');
      }
    }

    // Switch assignment tab
    function switchAssignTab(type, userId) {
      const tabs = ['todo', 'goal', 'reminder'];
      tabs.forEach(t => {
        const tab = document.getElementById(`assign-tab-${t}`);
        const panel = document.getElementById(`assign-panel-${t}`);
        if (t === type) {
          tab.className = 'flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-xs font-black uppercase tracking-wider bg-white text-indigo-600 shadow-sm transition-all border border-slate-200/50';
          panel.classList.remove('hidden');
        } else {
          tab.className = 'flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-xs font-black uppercase tracking-wider text-slate-500 hover:text-slate-800 transition-all';
          panel.classList.add('hidden');
        }
      });
    }

    // Assign item to student
    async function assignToStudent(type, studentId) {
      const feedback = document.getElementById('assign-feedback');
      let endpoint, body;

      if (type === 'todo') {
        const text = document.getElementById('assign-todo-text')?.value?.trim();
        const priority = document.getElementById('assign-todo-priority')?.value;
        const urgent = document.getElementById('assign-todo-urgent')?.value;
        if (!text) { showAssignFeedback('Please enter a task description.', 'error'); return; }
        endpoint = '/api/coach/assign-todo';
        body = { studentId, text, priority, urgent };
      } else if (type === 'goal') {
        const text = document.getElementById('assign-goal-text')?.value?.trim();
        const category = document.getElementById('assign-goal-category')?.value;
        const total = document.getElementById('assign-goal-total')?.value;
        if (!text) { showAssignFeedback('Please enter a goal title.', 'error'); return; }
        endpoint = '/api/coach/assign-goal';
        body = { studentId, text, category, total: parseFloat(total) || 0 };
      } else if (type === 'reminder') {
        const title = document.getElementById('assign-reminder-title')?.value?.trim();
        const when = document.getElementById('assign-reminder-when')?.value;
        if (!title) { showAssignFeedback('Please enter a reminder title.', 'error'); return; }
        endpoint = '/api/coach/assign-reminder';
        body = { studentId, title, when: when || null };
      }

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.error || 'Failed');

        // Clear input
        if (type === 'todo') document.getElementById('assign-todo-text').value = '';
        if (type === 'goal') { document.getElementById('assign-goal-text').value = ''; document.getElementById('assign-goal-total').value = ''; }
        if (type === 'reminder') { document.getElementById('assign-reminder-title').value = ''; document.getElementById('assign-reminder-when').value = ''; }

        showAssignFeedback('âœ“ Successfully assigned to student!', 'success');
      } catch (e) {
        showAssignFeedback('Error: ' + e.message, 'error');
      }
    }

    function showAssignFeedback(msg, type) {
      const el = document.getElementById('assign-feedback');
      if (!el) return;
      el.textContent = msg;
      el.className = `mt-8 p-4 rounded-2xl text-[10px] font-black uppercase tracking-widest text-center animate-in fade-in zoom-in duration-300 ${type === 'success' ? 'bg-green-50 text-green-600 border border-green-100' : 'bg-red-50 text-red-600 border border-red-100'
        }`;
      el.classList.remove('hidden');
      setTimeout(() => {
        el.classList.add('animate-out', 'fade-out', 'zoom-out');
        setTimeout(() => el.classList.add('hidden'), 300)
      }, 4000);
    }

    function closeUserProfileModal() {
      const modal = document.getElementById('userProfileModal');
      if (modal) modal.remove();
    }

    async function respondToRequest(userId, action) {
      if (!confirm(`Are you sure you want to ${action} this request?`)) return;

      try {
        const res = await fetch('/api/coach/respond-request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, action })
        });

        if (!res.ok) throw new Error('Failed to update request');

        // Close profile modal if open
        closeUserProfileModal();

        // Refresh list
        loadPendingRequests();

        // Update stats/clients if approved
        if (action === 'approve') {
          fetchStudents();
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Auto-load approvals count
    loadPendingRequests();

    // Analytics State
    let currentAnalyticsStudentId = null;

    async function handleAnalyticsFilterChange() {
      const filter = document.getElementById('analytics-filter').value;
      const overallView = document.getElementById('overall-analytics-view');
      const studentView = document.getElementById('student-analytics-view');

      if (filter === 'overall') {
        overallView.classList.remove('hidden');
        studentView.classList.add('hidden');
        currentAnalyticsStudentId = null;
        // Load overall stats if needed
      } else {
        overallView.classList.add('hidden');
        studentView.classList.remove('hidden');
        currentAnalyticsStudentId = Number(filter);
        await loadStudentAnalytics(currentAnalyticsStudentId);
      }
    }

    async function loadStudentAnalytics(studentId) {
      if (!studentId) return;

      try {
        // Instant Header Update
        const filter = document.getElementById('analytics-filter');
        const studentName = filter.options[filter.selectedIndex].text;
        document.getElementById('student-view-name').textContent = studentName;
        document.getElementById('student-view-avatar').textContent = studentName[0].toUpperCase();
        document.getElementById('student-view-email').textContent = 'Live Data Connected';

        const res = await fetch(`/api/coach/student-analytics/${studentId}`);
        if (!res.ok) throw new Error('Failed to fetch analytics');
        const data = await res.json();


        // 1. Update Productivity Badge
        const prodBadge = document.getElementById('student-productivity-badge');
        const total = data.stats.totalTasks;
        const done = data.stats.completedTasks;
        const percentage = total > 0 ? Math.round((done / total) * 100) : 0;

        if (prodBadge) {
          prodBadge.textContent = `Productivity: ${percentage}%`;
          prodBadge.className = `px-6 py-2.5 rounded-2xl text-xs font-black uppercase tracking-widest border shadow-sm shadow-emerald-100/50 ${percentage >= 70 ? 'bg-emerald-50 text-emerald-600 border-emerald-100' :
            percentage >= 40 ? 'bg-indigo-50 text-indigo-600 border-indigo-100' :
              'bg-orange-50 text-orange-600 border-orange-100'
            }`;
        }

        // Update other stats
        const weekGoals = document.getElementById('student-weekly-goals');
        if (weekGoals) weekGoals.textContent = `${done}/${total}`;

        const percLeft = document.getElementById('student-perc-left');
        if (percLeft) percLeft.textContent = `${100 - percentage}%`;

        // Update Active Day (Placeholder for now)
        const activeDay = document.getElementById('student-active-day');
        if (activeDay) activeDay.textContent = 'Wednesday';


        // 2. Render Goals
        const goalsList = document.getElementById('individual-goals-list');
        if (goalsList) {
          goalsList.innerHTML = '';
          if (data.goals.length === 0) {
            goalsList.innerHTML = `<div class="text-center p-6 text-slate-400 text-sm italic">No goals set yet</div>`;
          } else {
            data.goals.forEach(goal => {
              const progress = goal.total > 0 ? (goal.spent / goal.total) * 100 : 0;
              const div = document.createElement('div');
              div.className = 'flex flex-col gap-2';
              div.innerHTML = `
                 <div class="flex justify-between items-end">
                   <span class="text-slate-700 font-bold text-sm">${goal.text}</span>
                   <span class="text-[10px] font-black text-slate-400 uppercase">${Math.round(progress)}%</span>
                 </div>
                 <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                   <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full" style="width: ${progress}%"></div>
                 </div>
               `;
              goalsList.appendChild(div);
            });
          }
        }

        // 3. Render Recent Stats/Activity
        const activityList = document.getElementById('individual-recent-tasks');
        if (activityList) {
          activityList.innerHTML = '';
          if (data.recentTasks.length === 0) {
            activityList.innerHTML = `<div class="text-center p-6 text-slate-400 text-sm italic">No recent activity</div>`;
          } else {
            data.recentTasks.forEach(task => {
              const date = new Date(task.created_at).toLocaleDateString();
              const div = document.createElement('div');
              div.className = 'flex items-center gap-3 py-2 border-b border-slate-50 last:border-0';
              div.innerHTML = `
                  <div class="w-8 h-8 rounded-lg flex items-center justify-center ${task.done ? 'bg-green-50 text-green-600' : 'bg-slate-50 text-slate-400'}">
                    <i data-lucide="${task.done ? 'check' : 'clock'}" class="w-4 h-4"></i>
                  </div>
                  <div class="flex-1">
                     <p class="text-xs font-bold text-slate-700 ${task.done ? 'line-through opacity-50' : ''}">${task.text}</p>
                     <p class="text-[9px] font-bold text-slate-400 uppercase">${date}</p>
                  </div>
                `;
              activityList.appendChild(div);
            });
            lucide.createIcons();
          }
        }

        // 4. Update Goal Progress Center Count
        const goalDoneEl = document.getElementById('goal-done-count');
        if (goalDoneEl) {
          const finishedGoals = data.goals.filter(g => g.done === 1).length;
          goalDoneEl.textContent = finishedGoals;
        }

        // 5. Update Charts (Simple stubs for now to ensure they show up)
        initStudentDashboardCharts(data);


      } catch (e) {
        console.error("Analytics load error:", e);
      }
    }

    // Populate Student Dropdown & Overall Summary
    async function loadAnalyticsDropdown() {
      try {
        const res = await fetch('/api/coach/students');
        const students = await res.json();
        const select = document.getElementById('analytics-filter');

        // Populate Select
        select.innerHTML = '<option value="overall">Overall Workspace</option>';
        students.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = s.username;
          select.appendChild(opt);
        });

        // Populate Overall View Client List
        const listBody = document.getElementById('overall-client-list-body');
        if (listBody) {
          listBody.innerHTML = students.map(s => {
            const progress = s.totalTasks > 0 ? Math.round((s.tasksDone / s.totalTasks) * 100) : 0;
            return `
              <tr class="group hover:bg-slate-50/50 transition-colors">
                <td class="py-4 px-2">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-xs uppercase">
                      ${(s.username || 'U')[0]}
                    </div>
                    <div>
                      <p class="text-xs font-bold text-slate-700">${s.username}</p>
                      <p class="text-[9px] font-bold text-slate-400 uppercase tracking-tight">${s.email}</p>
                    </div>
                  </div>
                </td>
                <td class="py-4 px-2">
                   <div class="flex items-center gap-3">
                      <div class="flex-1 h-1.5 bg-slate-100 rounded-full overflow-hidden max-w-[100px]">
                        <div class="h-full bg-indigo-500 rounded-full" style="width: ${progress}%"></div>
                      </div>
                      <span class="text-[10px] font-black text-slate-400 uppercase">${progress}%</span>
                   </div>
                </td>
                <td class="py-4 px-2">
                   <span class="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-600 text-[9px] font-black uppercase tracking-widest">Active</span>
                </td>
                <td class="py-4 px-2">
                   <button onclick="document.getElementById('analytics-filter').value='${s.id}'; handleAnalyticsFilterChange();" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all">
                      <i data-lucide="eye" class="w-4 h-4"></i>
                   </button>
                </td>
              </tr>
            `;
          }).join('');
          lucide.createIcons();
        }

        // Populate Overall Stats
        if (document.getElementById('overall-total-clients')) {
          document.getElementById('overall-total-clients').textContent = students.length;
          document.getElementById('overall-active-clients').textContent = students.length;
          const avgProgress = students.length > 0
            ? Math.round(students.reduce((acc, s) => acc + (s.totalTasks > 0 ? (s.tasksDone / s.totalTasks * 100) : 0), 0) / students.length)
            : 0;
          document.getElementById('overall-avg-progress').textContent = `${avgProgress}%`;
        }

      } catch (e) { console.error("Dropdown load error:", e); }
    }

    // Initial Load
    loadAnalyticsDropdown();

    // Socket Listener for Real-Time Updates
    if (typeof io !== 'undefined') {
      const socket = io(getBackendUrl(), { withCredentials: true });
      // Logic handles "identify" in initCoachChat usually, but let's ensure we catch the event
      // verify if initCoachChat is called. It is. 
      // We can hook into the SAME socket instance if exposed, or just rely on initCoachChat being global?
      // `chatSocket` is the global variable from initCoachChat.

      // Just add this helper that waits for chatSocket to exist
      const checkSocket = setInterval(() => {
        if (window.chatSocket) {
          clearInterval(checkSocket);
          window.chatSocket.on('student_update', (data) => {
            console.log("Real-time update received:", data);
            if (currentAnalyticsStudentId && Number(data.studentId) === Number(currentAnalyticsStudentId)) {
              // Refresh current view
              loadStudentAnalytics(currentAnalyticsStudentId);

              // Optional: Toast notification
              // showToast(`Student updated ${data.type}`);
            }
          });
        }
      }, 500);
    }

    // Chart initialization helper
    function initStudentDashboardCharts(data) {
      const ctxActivity = document.getElementById('studentActivityChart')?.getContext('2d');
      const ctxGoal = document.getElementById('studentGoalChart')?.getContext('2d');

      if (ctxActivity) {
        if (window.sActivityChart) window.sActivityChart.destroy();
        // Aggregating task completion by date for last 7 days
        const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const values = [0, 0, 0, 0, 0, 0, 0];
        // data.recentTasks contains creation dates, we could use that if we had more data
        // For now, let's just use some sample data related to their completion
        values[2] = data.stats.completedTasks; // Just as an indicator

        window.sActivityChart = new Chart(ctxActivity, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Tasks',
              data: [0, 2, 4, 1, 0, 0, 0], // Sample trend
              backgroundColor: '#6366f1',
              borderRadius: 8
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      if (ctxGoal) {
        if (window.sGoalChart) window.sGoalChart.destroy();
        const done = data.goals.filter(g => g.done === 1).length;
        const pending = data.goals.length - done;

        window.sGoalChart = new Chart(ctxGoal, {
          type: 'doughnut',
          data: {
            labels: ['Done', 'Pending'],
            datasets: [{
              data: [done || 1, pending || 0.1], // Avoid empty charts
              backgroundColor: ['#6366f1', '#f1f5f9'],
              borderWidth: 0,
              cutout: '80%'
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }
    }

  </script>
  <script src="/js/tour-manager.js"></script>
  <script src="/js/coach-tour-manager.js"></script>
  <!-- <script src="/js/feedback.js"></script> -->
</body>

</html>