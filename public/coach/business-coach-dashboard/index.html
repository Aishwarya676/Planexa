<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coach Portal | Planexa</title>
  <meta name="description" content="Coach Dashboard for managing clients and business" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="/js/auth-helper.js"></script>

  <!-- Import Main Styles to match App exactly -->
  <link rel="stylesheet" href="../../css/styles.css?v=role1" />

  <style>
    /* Tab System matching app.html */
    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block !important;
    }

    /* Animation matching app.html/styles.css */
    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fade-in 0.3s ease-in-out;
    }

    /* Premium Card Styles */
    .glass-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
      transition: all 0.3s ease;
    }

    .glass-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.12);
    }

    .stat-card {
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle at center, var(--glow-color, rgba(99, 102, 241, 0.1)) 0%, transparent 70%);
      transform: translate(30%, -30%);
      pointer-events: none;
    }

    .user-card {
      background: white;
      border: 1px solid #f1f5f9;
      border-radius: 1.5rem;
      padding: 1.5rem;
      transition: all 0.2s ease;
    }

    .user-card:hover {
      border-color: #e2e8f0;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
    }

    /* Dropdown Animation */
    #coach-profile-dropdown.show {
      opacity: 1;
      pointer-events: auto;
      transform: scale(100%);
    }

    .dropdown-item {
      cursor: pointer;
    }
  </style>
</head>

<body style="background-color: #e0f2ff;"> <!-- Exact User App BG -->

  <!-- HEADER: Exact replica of app.html header structure -->
  <header class="sticky top-0 z-10 header-dark">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center gap-4">

      <!-- Brand -->
      <a href="#" onclick="event.preventDefault(); window.location.replace('#');" class="flex items-center gap-3">
        <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center">
          <i data-lucide="rocket" class="w-6 h-6 text-white"></i>
        </div>
        <span
          class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">Planexa</span>
      </a>

      <!-- Nav Tabs -->
      <nav class="ml-auto">
        <ul class="flex gap-2 items-center" id="tabs">
          <li><button data-tab="users" class="tab-btn active">Users</button></li>
          <li><button data-tab="analytics" class="tab-btn">Analytics</button></li>
          <li><button data-tab="approvals" class="tab-btn flex items-center gap-1">Approvals <span id="approval-count"
                class="hidden bg-orange-600 text-white text-[9px] font-black px-1.5 py-0.5 rounded-full shadow-lg shadow-orange-200 animate-pulse">0</span></button>
          </li>
          <li><button data-tab="messages" class="tab-btn flex items-center gap-1.5">
              <i data-lucide="message-square" class="w-3.5 h-3.5"></i> Messages
            </button></li>

          <!-- Profile Dropdown -->
          <li class="relative ml-4" id="coach-profile-dropdown-container">
            <button id="coach-profile-btn"
              class="flex items-center gap-3 px-3 py-2 rounded-2xl bg-white/10 hover:bg-white/20 transition-all border border-white/10 group">
              <div id="nav-profile-img-container"
                class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-indigo-500/20 group-hover:scale-105 transition-transform overflow-hidden">
                <i data-lucide="user" class="w-4 h-4"></i>
              </div>
              <span class="font-black text-white text-xs uppercase tracking-widest hidden sm:block">Profile</span>
              <i data-lucide="chevron-down" id="nav-profile-chevron"
                class="w-4 h-4 text-white/40 transition-transform"></i>
            </button>

            <!-- Dropdown Menu -->
            <div id="coach-profile-dropdown"
              class="absolute right-0 mt-3 w-64 bg-white/95 backdrop-blur-xl rounded-[2rem] shadow-2xl border border-slate-200/50 overflow-hidden transform scale-95 opacity-0 pointer-events-none transition-all duration-300 z-50 origin-top-right">
              <div class="p-4 space-y-1.5">
                <!-- Edit Profile -->
                <button data-tab="profile"
                  class="dropdown-item w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-slate-50 transition-all group text-left">
                  <div
                    class="w-10 h-10 bg-indigo-50 rounded-xl text-indigo-600 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-all shadow-sm">
                    <i data-lucide="user-cog" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <span class="block font-black text-slate-800 text-xs uppercase tracking-tight">Edit Profile</span>
                    <span class="block text-[10px] font-bold text-slate-400 uppercase leading-none mt-1">Public
                      Portfolio</span>
                  </div>
                </button>

                <!-- Create Article -->
                <button data-tab="create"
                  class="dropdown-item w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-slate-50 transition-all group text-left">
                  <div
                    class="w-10 h-10 bg-purple-50 rounded-xl text-purple-600 flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition-all shadow-sm">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <span class="block font-black text-slate-800 text-xs uppercase tracking-tight">Create Article</span>
                    <span class="block text-[10px] font-bold text-slate-400 uppercase leading-none mt-1">Publish to
                      Blog</span>
                  </div>
                </button>

                <!-- Settings -->
                <button data-tab="settings"
                  class="dropdown-item w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-slate-50 transition-all group text-left text-red-600">
                  <div
                    class="w-10 h-10 bg-red-50 rounded-xl text-red-600 flex items-center justify-center group-hover:bg-red-600 group-hover:text-white transition-all shadow-sm">
                    <i data-lucide="shield-alert" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <span class="block font-black text-slate-800 text-xs uppercase tracking-tight">Settings</span>
                    <span class="block text-[10px] font-bold text-red-400 uppercase leading-none mt-1">Danger
                      Zone</span>
                  </div>
                </button>

                <div class="h-px bg-slate-100 my-2 mx-2"></div>

                <!-- Log Out -->
                <button id="logoutBtn"
                  class="dropdown-item w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-red-50 transition-all group text-left">
                  <div
                    class="w-10 h-10 bg-white border border-red-100 rounded-xl text-red-600 flex items-center justify-center group-hover:bg-red-600 group-hover:text-white transition-all shadow-sm">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <span class="block font-black text-red-600 text-xs uppercase tracking-tight">Log Out</span>
                    <span class="block text-[10px] font-bold text-slate-400 uppercase leading-none mt-1">Secure Sign
                      Out</span>
                  </div>
                </button>
              </div>
            </div>
          </li>
        </ul>
      </nav>

    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="max-w-5xl mx-auto px-4 py-8">

    <!-- TAB: USERS -->
    <section id="tab-users" class="tab-panel active fade-in">

      <!-- Stats Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
        <div class="glass-card stat-card p-6 rounded-3xl" style="--glow-color: rgba(59, 130, 246, 0.15)">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xs font-bold text-blue-600 uppercase tracking-wider">Total Clients</p>
              <h3 class="text-4xl font-black text-slate-800 mt-2">0</h3>
            </div>
            <div class="p-3 bg-blue-50 text-blue-600 rounded-2xl shadow-inner"><i data-lucide="users"
                class="w-6 h-6"></i></div>
          </div>
          <div class="mt-4 text-xs font-medium text-slate-400 flex items-center gap-2">
            <span class="flex h-2 w-2 rounded-full bg-blue-400"></span>
            <span>Active learning sessions</span>
          </div>
        </div>

        <div class="glass-card stat-card p-6 rounded-3xl" style="--glow-color: rgba(168, 85, 247, 0.15)">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xs font-bold text-purple-600 uppercase tracking-wider">Total Revenue</p>
              <h3 class="text-4xl font-black text-slate-800 mt-2">â‚¹0</h3>
            </div>
            <div class="p-3 bg-purple-50 text-purple-600 rounded-2xl shadow-inner"><i data-lucide="banknote"
                class="w-6 h-6"></i></div>
          </div>
          <div class="mt-4 text-xs font-medium text-slate-400 flex items-center gap-2">
            <span class="flex h-2 w-2 rounded-full bg-purple-400"></span>
            <span>Platform earnings</span>
          </div>
        </div>
      </div>

      <!-- Clients Section -->
      <div class="glass-card p-6 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
        <div class="flex items-center justify-between mb-8">
          <div>
            <h2 class="text-2xl font-black text-slate-800">My Clients</h2>
            <p class="text-sm text-slate-500 font-medium">Manage and monitor your active students</p>
          </div>
        </div>

        <!-- Empty State Container -->
        <div id="no-clients-msg" class="flex flex-col items-center justify-center p-16 text-center hidden">
          <div class="w-20 h-20 bg-indigo-50 text-indigo-200 rounded-3xl flex items-center justify-center mb-6">
            <i data-lucide="users" class="w-10 h-10"></i>
          </div>
          <h3 class="text-xl font-bold text-slate-800">No clients yet</h3>
          <p class="text-slate-500 max-w-xs mx-auto mt-2">When you approve student requests, they will appear here as
            your active clients.</p>
        </div>

        <!-- Users Grid (Now a Vertical Stack) -->
        <div id="users-grid" class="flex flex-col gap-4">
          <!-- Populated by JS -->
        </div>
      </div>
    </section>

    <!-- TAB: ANALYTICS -->
    <section id="tab-analytics" class="tab-panel fade-in">
      <div class="glass-card mb-8 flex flex-col md:flex-row md:items-center justify-between p-6 rounded-[2rem] gap-4">
        <div>
          <h2 class="text-2xl font-black text-slate-800">Performance Tracking</h2>
          <p class="text-sm text-slate-500 font-medium">Analyze overall growth or individual student progress</p>
        </div>
        <div class="flex items-center gap-4 bg-slate-50 p-2 rounded-2xl border border-slate-100">
          <label for="analytics-filter"
            class="text-xs font-bold text-slate-500 uppercase px-2 tracking-wider">Viewing:</label>
          <select id="analytics-filter" onchange="handleAnalyticsFilterChange()"
            class="rounded-xl border-none focus:ring-0 text-sm font-bold p-2.5 bg-white text-indigo-600 shadow-sm cursor-pointer min-w-[180px]">
            <option value="overall">Overall Workspace</option>
            <!-- Students populated via JS -->
          </select>
        </div>
      </div>

      <!-- OVERALL VIEW -->
      <div id="overall-analytics-view" class="space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="glass-card p-8 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
            <div class="flex items-center justify-between mb-8">
              <h3 class="text-lg font-black text-slate-800 flex items-center gap-2">
                <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-600"></i> Activity Overview
              </h3>
            </div>
            <div class="relative h-[250px]">
              <canvas id="activityChart"></canvas>
            </div>
          </div>
          <div class="glass-card p-8 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
            <div class="flex items-center justify-between mb-8">
              <h3 class="text-lg font-black text-slate-800 flex items-center gap-2">
                <i data-lucide="trending-up" class="w-5 h-5 text-emerald-600"></i> Client Acquisition
              </h3>
            </div>
            <div class="relative h-[250px]">
              <canvas id="growthChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- INDIVIDUAL STUDENT VIEW -->
      <div id="student-analytics-view" class="hidden space-y-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Main Chart -->
          <div
            class="lg:col-span-2 glass-card p-8 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
            <div class="flex items-center justify-between mb-8">
              <h3 class="text-lg font-black text-slate-800 flex items-center gap-2">
                <i data-lucide="activity" class="w-5 h-5 text-indigo-600"></i> Task Completion Trend
              </h3>
              <div id="student-productivity-badge"
                class="px-4 py-1.5 bg-indigo-50 text-indigo-700 rounded-xl text-[10px] font-black uppercase tracking-wider">
                Productivity: --%
              </div>
            </div>
            <div class="relative h-[300px]">
              <canvas id="individualTaskChart"></canvas>
            </div>
          </div>

          <!-- Goal Stats -->
          <div class="glass-card p-8 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
            <h3 class="text-lg font-black text-slate-800 mb-8 flex items-center gap-2">
              <i data-lucide="target" class="w-5 h-5 text-orange-500"></i> Active Goals
            </h3>
            <div id="individual-goals-list" class="space-y-6">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <!-- Recent Activity Summary -->
        <div class="glass-card p-8 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
          <h3 class="text-lg font-black text-slate-800 mb-6 flex items-center gap-2">
            <i data-lucide="zap" class="w-5 h-5 text-amber-500"></i> Engagement Summary
          </h3>
          <div id="individual-recent-tasks">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: APPROVALS -->
    <section id="tab-approvals" class="tab-panel fade-in">
      <div class="glass-card p-6 rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50">
        <div class="flex items-center justify-between mb-8">
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="flex h-2 w-2 rounded-full bg-orange-500 animate-ping"></span>
              <h2 class="text-2xl font-black text-slate-800">New Coaching Requests</h2>
            </div>
            <p class="text-sm text-slate-500 font-medium">Review and approve new potential clients wanting to join you
            </p>
          </div>
        </div>

        <!-- Empty State Container -->
        <div id="approvals-empty" class="flex flex-col items-center justify-center p-16 text-center hidden">
          <div class="w-20 h-20 bg-orange-50 text-orange-200 rounded-3xl flex items-center justify-center mb-6">
            <i data-lucide="shield-check" class="w-10 h-10"></i>
          </div>
          <h3 class="text-xl font-bold text-slate-800">All caught up!</h3>
          <p class="text-slate-500 max-w-xs mx-auto mt-2">There are no pending coaching requests at the moment. Great
            job!</p>
        </div>

        <!-- Requests Stack -->
        <div id="approvals-list" class="flex flex-col gap-4">
          <!-- Populated by JS -->
        </div>
      </div>
    </section>
    <section id="tab-profile" class="tab-panel fade-in">
      <div class="max-w-4xl mx-auto">
        <!-- Profile Header / Banner -->
        <div
          class="glass-card mb-8 overflow-hidden rounded-[2.5rem] border border-slate-100 shadow-2xl shadow-slate-200/50">
          <div class="h-44 bg-gradient-to-br from-indigo-600 via-purple-600 to-indigo-700 relative overflow-hidden">
            <!-- Mesh Glow Effects -->
            <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -mr-20 -mt-20"></div>
            <div class="absolute bottom-0 left-0 w-48 h-48 bg-purple-400/20 rounded-full blur-2xl -ml-10 -mb-10"></div>
          </div>

          <div class="relative px-10 pb-10">
            <div class="flex flex-col md:flex-row md:items-end justify-between -mt-16 gap-6">
              <div class="flex flex-col md:flex-row md:items-end gap-6">
                <div class="relative group">
                  <div
                    class="absolute -inset-1.5 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-[2.5rem] blur opacity-20 transition duration-500 group-hover:opacity-40">
                  </div>
                  <img id="profile-img" src="https://ui-avatars.com/api/?name=Coach&background=random"
                    class="relative w-36 h-36 rounded-[2.2rem] border-4 border-white shadow-2xl object-cover bg-white">
                </div>
                <div class="pb-2">
                  <h2 id="profile-name" class="text-4xl font-black text-slate-800 tracking-tight">Loading...</h2>
                  <div class="flex items-center gap-2 mt-2">
                    <span id="profile-category"
                      class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-black uppercase tracking-widest border border-indigo-100/50">Business</span>
                    <span class="text-slate-400 font-bold text-sm" id="profile-email">...</span>
                  </div>
                </div>
              </div>

              <div class="flex gap-3 pb-2">
                <a href="edit-profile.html"
                  class="px-8 py-3.5 bg-slate-900 text-white rounded-2xl text-xs font-black uppercase tracking-widest hover:bg-slate-800 transition-all shadow-xl shadow-slate-200 flex items-center gap-2">
                  <i data-lucide="settings" class="w-4 h-4"></i> Edit Profile
                </a>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Left: About Section -->
          <div class="lg:col-span-2 space-y-8">
            <div class="glass-card p-10 rounded-[2.5rem] border border-slate-100">
              <div class="flex items-center gap-3 mb-8">
                <div class="p-2.5 bg-indigo-50 text-indigo-600 rounded-2xl">
                  <i data-lucide="user-plus" class="w-6 h-6"></i>
                </div>
                <h3 class="text-xl font-black text-slate-800 tracking-tight">Professional Bio</h3>
              </div>
              <p id="profile-bio" class="text-lg font-medium text-slate-500 leading-relaxed italic">
                ...
              </p>
            </div>

          </div>

          <!-- Right: Stats & Quick Info -->
          <div class="space-y-8">
            <div
              class="glass-card p-8 rounded-[2.5rem] border border-slate-100 bg-gradient-to-br from-white to-slate-50">
              <h3
                class="text-xs font-black text-slate-400 uppercase tracking-widest mb-8 border-b border-slate-100 pb-4">
                Activity Stats</h3>

              <div class="space-y-8">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-4">
                    <div
                      class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-indigo-600 shadow-sm border border-slate-50">
                      <i data-lucide="briefcase" class="w-6 h-6"></i>
                    </div>
                    <div>
                      <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Experience</p>
                      <p id="profile-experience" class="text-sm font-black text-slate-800">...</p>
                    </div>
                  </div>
                </div>

                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-4">
                    <div
                      class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-purple-600 shadow-sm border border-slate-50">
                      <i data-lucide="clock" class="w-6 h-6"></i>
                    </div>
                    <div>
                      <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Hours Coached</p>
                      <p id="profile-hours" class="text-sm font-black text-slate-800">0 hrs</p>
                    </div>
                  </div>
                </div>

                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-4">
                    <div
                      class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-emerald-600 shadow-sm border border-slate-50">
                      <i data-lucide="zap" class="w-6 h-6"></i>
                    </div>
                    <div>
                      <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Response Time</p>
                      <p class="text-sm font-black text-slate-800">&lt; 2 hours</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: CREATE ARTICLE -->
    <section id="tab-create" class="tab-panel">
      <div class="max-w-4xl mx-auto card p-0 overflow-hidden bg-white">
        <div class="p-6 border-b border-gray-100 bg-white">
          <h2 class="text-xl font-bold text-gray-800">Create New Article</h2>
          <p class="text-sm text-gray-500">Fill in the details below to create a new article for your business coaching
            blog.</p>
        </div>

        <div class="p-8">
          <form id="articleForm" class="space-y-8">
            <!-- Title & Description -->
            <div class="space-y-4">
              <div class="flex items-center gap-2 border-b border-gray-100 pb-2">
                <i data-lucide="heading" class="w-5 h-5 text-indigo-600"></i>
                <h3 class="text-lg font-semibold text-gray-800">Title & Description</h3>
              </div>

              <div class="grid gap-4">
                <div>
                  <label for="articleTitle" class="block text-sm font-medium text-gray-700 mb-1">Title Tag*</label>
                  <input type="text" id="articleTitle"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    placeholder="Enter article title" required>
                </div>

                <div>
                  <label for="articleDescription" class="block text-sm font-medium text-gray-700 mb-1">Meta
                    Description*</label>
                  <textarea id="articleDescription" rows="3"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    placeholder="Enter a brief description for search engines (150-160 characters)" required></textarea>
                  <p class="text-xs text-gray-500 mt-1">This helps with SEO and appears in search results.</p>
                </div>
              </div>
            </div>

            <!-- Content Section -->
            <div class="space-y-4">
              <div class="flex items-center gap-2 border-b border-gray-100 pb-2">
                <i data-lucide="file-text" class="w-5 h-5 text-indigo-600"></i>
                <h3 class="text-lg font-semibold text-gray-800">Article Content</h3>
              </div>

              <div class="grid gap-4">
                <div>
                  <label for="articleContent" class="block text-sm font-medium text-gray-700 mb-1">Content*</label>
                  <textarea id="articleContent" rows="10"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    placeholder="Write your article content here..." required></textarea>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Featured Image</label>
                  <div
                    class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors cursor-pointer relative overflow-hidden"
                    id="imageUpload">
                    <div id="image-placeholder">
                      <i data-lucide="upload-cloud" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                      <p class="text-sm text-gray-600">Click to upload or drag and drop</p>
                      <p class="text-xs text-gray-400 mt-1">PNG, JPG, GIF up to 5MB</p>
                    </div>
                    <div id="image-preview-container"
                      class="hidden absolute inset-0 bg-white flex items-center justify-center">
                      <img id="image-preview" src="" class="max-h-full max-w-full object-contain">
                      <button type="button" id="remove-image"
                        class="absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 shadow-md">
                        <i data-lucide="x" class="w-4 h-4"></i>
                      </button>
                    </div>
                    <input type="file" id="featuredImage" accept="image/*" class="hidden">
                  </div>
                </div>
              </div>
            </div>

            <!-- SEO & Technical -->
            <div class="space-y-4">
              <div class="flex items-center gap-2 border-b border-gray-100 pb-2">
                <i data-lucide="search" class="w-5 h-5 text-indigo-600"></i>
                <h3 class="text-lg font-semibold text-gray-800">SEO & Technical Details</h3>
              </div>

              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label for="slug" class="block text-sm font-medium text-gray-700 mb-1">URL Slug*</label>
                  <input type="text" id="slug"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    placeholder="custom-url-slug" required>
                  <p class="text-xs text-gray-500 mt-1">Part of the article URL.</p>
                </div>
                <div>
                  <label for="keywords" class="block text-sm font-medium text-gray-700 mb-1">Focus Keywords</label>
                  <input type="text" id="keywords"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    placeholder="business, coaching, strategy">
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Meta Robots</label>
                <div class="space-y-2">
                  <label class="flex items-center gap-2">
                    <input type="checkbox" id="indexPage" checked
                      class="rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                    <span class="text-sm text-gray-700">Allow search engines to index this page</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" id="followLinks" checked
                      class="rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                    <span class="text-sm text-gray-700">Allow search engines to follow links on this page</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Categorization -->
            <div class="space-y-4">
              <div class="flex items-center gap-2 border-b border-gray-100 pb-2">
                <i data-lucide="tag" class="w-5 h-5 text-indigo-600"></i>
                <h3 class="text-lg font-semibold text-gray-800">Categorization</h3>
              </div>

              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category*</label>
                  <select id="category"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    required>
                    <option value="">Select a category</option>
                    <option value="business-strategy">Business Strategy</option>
                    <option value="leadership">Leadership</option>
                    <option value="marketing">Marketing</option>
                    <option value="productivity">Productivity</option>
                    <option value="career-growth">Career Growth</option>
                    <option value="entrepreneurship">Entrepreneurship</option>
                  </select>
                </div>
                <div>
                  <label for="tags" class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                  <input type="text" id="tags"
                    class="w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm p-2 border"
                    placeholder="Add tags separated by commas">
                </div>
              </div>
              <div>
                <label class="flex items-center gap-2 mt-2">
                  <input type="checkbox" id="featured"
                    class="rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                  <span class="text-sm text-gray-700 font-medium">Mark as featured article</span>
                </label>
              </div>
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-end gap-3 pt-4 border-t border-gray-100">
              <button type="button"
                class="btn btn-outline text-gray-600 border-gray-300 hover:bg-gray-50 flex items-center gap-2">
                <i data-lucide="x" class="w-4 h-4"></i> Cancel
              </button>
              <button type="submit"
                class="btn btn-primary bg-indigo-600 hover:bg-indigo-700 text-white flex items-center gap-2 px-6">
                <i data-lucide="save" class="w-4 h-4"></i> Publish Article
              </button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- TAB: MESSAGES (Full Page Redesign) -->
    <section id="tab-messages" class="tab-panel fade-in h-[calc(100vh-12rem)]">
      <div
        class="h-full glass-card rounded-[2.5rem] border border-slate-100 overflow-hidden shadow-2xl shadow-slate-200/50 flex">
        <!-- Sidebar: Client List -->
        <div class="w-80 border-r border-slate-100 flex flex-col bg-slate-50/50 text-slate-800">
          <div class="p-6 border-b border-slate-100 bg-white/80 backdrop-blur-md sticky top-0 z-10">
            <h3 class="text-xl font-black text-slate-800 tracking-tight flex items-center gap-2">
              <i data-lucide="users" class="w-5 h-5 text-indigo-600"></i> Clients
            </h3>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Select a client to chat</p>
          </div>

          <div id="full-chat-user-list" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1">
            <!-- Populated by JS -->
            <div class="animate-pulse p-4 space-y-3 font-semibold">
              <div class="h-12 bg-slate-200 rounded-2xl w-full"></div>
              <div class="h-12 bg-slate-200 rounded-2xl w-full"></div>
            </div>
          </div>
        </div>

        <!-- Main Area: Conversation -->
        <div class="flex-1 flex flex-col bg-white relative">
          <!-- Active Header -->
          <div id="full-chat-header"
            class="p-6 border-b border-slate-100 flex items-center justify-between bg-white/80 backdrop-blur-md sticky top-0 z-10 hidden">
            <div class="flex items-center gap-4">
              <div class="relative">
                <div id="full-chat-user-avatar"
                  class="w-12 h-12 rounded-2xl bg-indigo-500 flex items-center justify-center text-white font-black text-lg shadow-lg shadow-indigo-200">
                  ?
                </div>
                <div id="full-chat-status-dot"
                  class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-white bg-slate-300 shadow-sm">
                </div>
              </div>
              <div>
                <h3 id="full-chat-user-name" class="text-lg font-black text-slate-800 tracking-tight">Active Client</h3>
                <p id="full-chat-status-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                  Offline</p>
              </div>
            </div>
          </div>

          <!-- Messages Container -->
          <div id="full-chat-messages" class="flex-1 overflow-y-auto p-8 space-y-6 custom-scrollbar bg-slate-50/20">
            <div id="full-chat-empty-state"
              class="h-full flex flex-col items-center justify-center text-center space-y-4">
              <div
                class="w-20 h-20 bg-indigo-50 text-indigo-200 rounded-[2rem] flex items-center justify-center shadow-inner">
                <i data-lucide="message-circle" class="w-10 h-10"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold text-slate-800">Your Communication Hub</h3>
                <p class="text-slate-500 max-w-xs mt-2 text-sm font-semibold">Select a client from the sidebar to start
                  a real-time
                  conversation.</p>
              </div>
            </div>
            <!-- Messages populated here -->
          </div>

          <!-- Input Area -->
          <div id="full-chat-input-container" class="p-6 border-t border-slate-100 bg-white hidden">
            <form id="full-chat-form"
              class="flex gap-4 items-center bg-slate-50 p-3 rounded-[1.5rem] border border-slate-200 focus-within:border-indigo-300 focus-within:ring-4 focus-within:ring-indigo-500/5 transition-all">
              <input id="full-chat-input" type="text" autocomplete="off" placeholder="Type your message..."
                class="flex-1 bg-transparent border-none py-2 px-4 text-sm text-slate-800 focus:ring-0 outline-none font-medium">
              <button type="submit"
                class="p-3 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 active:scale-95">
                <i data-lucide="send-horizontal" class="w-5 h-5"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
    </section>


    <!-- TAB: SETTINGS -->
    <section id="tab-settings" class="tab-panel">
      <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm mb-8">
          <div class="p-8 border-b border-slate-100 bg-red-50/20">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-red-100 text-red-600 rounded-xl flex items-center justify-center">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold text-slate-800">Danger Zone</h3>
                <p class="text-sm text-slate-500 font-medium tracking-tight">Irreversible account actions</p>
              </div>
            </div>
          </div>

          <div class="divide-y divide-slate-100">
            <div class="p-8 flex items-center justify-between hover:bg-slate-50 transition-colors">
              <div>
                <p class="font-bold text-slate-800">Deactivate Account</p>
                <p class="text-xs text-slate-500 mt-1">Hide your profile and pause client interactions</p>
              </div>
              <button id="deactivateAccBtn"
                class="px-5 py-2.5 bg-amber-50 text-amber-600 rounded-xl text-xs font-bold hover:bg-amber-100 transition-all border border-amber-100">
                Deactivate
              </button>
            </div>

            <div class="p-8 flex items-center justify-between hover:bg-red-50/30 transition-colors">
              <div>
                <p class="font-bold text-red-600">Delete Account</p>
                <p class="text-xs text-slate-500 mt-1">Permanently remove your account and all data</p>
              </div>
              <button id="deleteAccBtn"
                class="px-5 py-2.5 bg-red-600 text-white rounded-xl text-xs font-bold hover:bg-red-700 transition-all shadow-md">
                Delete Account
              </button>
            </div>
          </div>
        </div>

        <!-- Logout button removed from here and moved to navbar -->
      </div>
    </section>


  </main>

  <script>
    // INITIALIZATION
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      initTabs();
      initCharts();
      fetchProfile();
      fetchStudents();
      fetchRequests();
      initArticleForm();
      initArticleImageUpload();

      // Chat specific listeners
      const fullChatForm = document.getElementById('full-chat-form');
      if (fullChatForm) {
        fullChatForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const input = document.getElementById('full-chat-input');
          const content = input?.value.trim();
          if (!content || !activeChatUser || !chatSocket) return;

          appendCoachMessage({
            content,
            sender_id: Number(coachInfo.id),
            sender_type: 'coach',
            created_at: new Date()
          }, 'outgoing');

          chatSocket.emit('send_message', { receiverId: Number(activeChatUser.id), content });
          if (input) input.value = '';
        });
      }

      initCoachChat();
      initAccountManagement();
    });

    function initAccountManagement() {
      const deactivateBtn = document.getElementById('deactivateAccBtn');
      const deleteBtn = document.getElementById('deleteAccBtn');

      if (deactivateBtn) {
        deactivateBtn.addEventListener('click', async () => {
          if (!confirm("Are you sure you want to deactivate your account? Your profile will be hidden and interactions will be paused. You can log back in later to reactivate.")) return;

          try {
            const res = await fetch('/api/coach/deactivate', { method: 'POST' });
            if (!res.ok) throw new Error(await res.text());
            alert("Account deactivated. You will now be logged out.");
            window.location.replace('/landing.html');
          } catch (e) {
            alert("Error: " + e.message);
          }
        });
      }

      if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
          if (!confirm("CRITICAL: Are you sure you want to DELETE your account? This action is permanent and you will not be able to log back in. Your data will be preserved for administrative purposes but your access will be revoked.")) return;

          try {
            const res = await fetch('/api/coach/delete', { method: 'POST' });
            if (!res.ok) throw new Error(await res.text());
            alert("Account deleted. Thank you for using PlannIt.");
            window.location.replace('/landing.html');
          } catch (e) {
            alert("Error: " + e.message);
          }
        });
      }
    }

    async function fetchRequests() {
      try {
        const res = await fetch('/api/coach/requests');
        if (!res.ok) throw new Error('Failed to fetch requests');
        const requests = await res.json();

        // Update Badge
        const badge = document.getElementById('approval-count');
        if (badge) {
          if (requests.length > 0) {
            badge.textContent = requests.length;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }

        const container = document.getElementById('approvals-list');
        const emptyState = document.getElementById('approvals-empty');

        if (requests.length === 0) {
          if (emptyState) emptyState.classList.remove('hidden');
          if (container) container.innerHTML = '';
        } else {
          if (emptyState) emptyState.classList.add('hidden');
          if (container) {
            container.innerHTML = requests.map(req => `
              <div class="user-card fade-in flex flex-col md:flex-row md:items-center gap-6 border-l-4 border-l-orange-500">
                <div class="flex items-center gap-4 min-w-[240px]">
                  <div class="w-14 h-14 rounded-2xl bg-orange-600 flex items-center justify-center text-white font-black text-xl shadow-lg shadow-orange-100 shrink-0">
                    ${req.username.substring(0, 1).toUpperCase()}
                  </div>
                  <div class="min-w-0">
                    <h4 class="font-bold text-slate-800 truncate">${req.username}</h4>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter truncate">${req.email}</p>
                    <div class="mt-1">
                       <span class="text-[9px] font-black text-orange-600 uppercase tracking-widest">Wants to join you</span>
                    </div>
                  </div>
                </div>

                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <i data-lucide="calendar" class="w-3 h-3 text-slate-400"></i>
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Received On</span>
                  </div>
                  <p class="text-sm font-black text-slate-700">${new Date(req.created_at).toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' })}</p>
                </div>

                <div class="flex items-center gap-2 shrink-0">
                  <button onclick="rejectRequest(${req.id})" 
                    class="px-6 py-3 bg-white border border-slate-100 text-slate-400 hover:text-red-500 hover:border-red-100 rounded-2xl text-xs font-black uppercase tracking-wider transition-all">
                    Reject
                  </button>
                  <button onclick="approveRequest(${req.id})" 
                    class="px-8 py-3 bg-indigo-600 text-white rounded-2xl text-xs font-black uppercase tracking-wider hover:bg-slate-900 transition-all shadow-lg shadow-indigo-100 cursor-pointer">
                    Approve Request
                  </button>
                </div>
              </div>
            `).join('');
            lucide.createIcons();
          }
        }
      } catch (e) {
        console.error("Error loading requests:", e);
      }
    }

    async function approveRequest(userId) {
      if (!confirm("Approve this student? They will be added to your client list.")) return;
      try {
        const res = await fetch(`/api/coach/requests/${userId}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'active' })
        });
        if (!res.ok) throw new Error("Failed to approve");
        // Refresh
        fetchRequests();
        fetchStudents();
        initCharts(); // Update charts to reflect new data
        alert("Student approved!");
      } catch (e) {
        alert(e.message);
      }
    }

    async function rejectRequest(userId) {
      if (!confirm("Reject this request?")) return;
      try {
        const res = await fetch(`/api/coach/requests/${userId}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'rejected' })
        });
        if (!res.ok) throw new Error("Failed to reject");
        fetchRequests();
      } catch (e) {
        alert(e.message);
      }
    }

    async function fetchStudents() {
      try {
        const res = await fetch('/api/coach/students');
        if (!res.ok) throw new Error('Failed to fetch students');
        const students = await res.json();

        // Update Stats
        const statsHeaders = document.querySelectorAll('.stat-card h3');
        if (statsHeaders[0]) statsHeaders[0].textContent = students.length;

        // Update Grid
        const grid = document.getElementById('users-grid');
        const noClientsMsg = document.getElementById('no-clients-msg');
        const filterSelect = document.getElementById('analytics-filter');

        // Reset filter select to just "Overall"
        if (filterSelect) {
          filterSelect.innerHTML = '<option value="overall">Overall Workspace</option>';
        }

        if (students.length > 0) {
          if (noClientsMsg) noClientsMsg.style.display = 'none';

          grid.innerHTML = ''; // Clear old cards
          students.forEach(student => {
            const progress = student.totalTasks > 0 ? Math.round((student.tasksDone / student.totalTasks) * 100) : 0;
            const card = document.createElement('div');
            card.className = 'user-card fade-in flex flex-col md:flex-row md:items-center gap-6';
            card.innerHTML = `
                <div class="flex items-center gap-4 min-w-[240px]">
                  <div class="w-14 h-14 rounded-2xl bg-indigo-600 flex items-center justify-center text-white font-black text-xl shadow-lg shadow-indigo-100 shrink-0">
                    ${student.username.substring(0, 1).toUpperCase()}
                  </div>
                  <div class="min-w-0">
                    <h4 class="font-bold text-slate-800 truncate">${student.username}</h4>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter truncate">${student.email}</p>
                    <div class="mt-1 flex items-center gap-2">
                       <span class="px-1.5 py-0.5 bg-green-50 text-green-600 rounded text-[9px] font-black uppercase tracking-wider">Active</span>
                    </div>
                  </div>
                </div>

                <div class="flex-1">
                  <div class="flex justify-between items-center mb-1.5">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Task Progress</span>
                    <span class="text-xs font-black text-indigo-600">${progress}%</span>
                  </div>
                  <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                    <div class="bg-indigo-600 h-full rounded-full transition-all duration-1000 shadow-[0_0_12px_rgba(99,102,241,0.4)]" style="width: ${progress}%"></div>
                  </div>
                </div>

                <div class="flex items-center gap-8 px-4">
                  <div class="text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Goals</p>
                    <p class="text-base font-black text-slate-800 leading-tight">${student.totalGoals || 0}</p>
                  </div>
                  <div class="text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Tasks</p>
                    <p class="text-base font-black text-slate-800 leading-tight">${student.tasksDone || 0}</p>
                  </div>
                </div>

                <div class="flex gap-2 shrink-0">
                  <button onclick="openChatWithStudent(${student.id}, '${student.username}')" 
                    class="p-3 bg-indigo-50 text-indigo-600 rounded-2xl hover:bg-indigo-100 transition-colors" title="Message">
                    <i data-lucide="message-square" class="w-5 h-5"></i>
                  </button>
                  <button onclick="viewStudentDetails(${student.id})" 
                    class="px-6 py-3 bg-slate-900 text-white rounded-2xl text-xs font-black uppercase tracking-wider hover:bg-black transition-all shadow-lg shadow-slate-200">
                    Analytics
                  </button>
                </div>
            `;
            grid.appendChild(card);

            // Add to dropdown
            if (filterSelect) {
              const opt = document.createElement('option');
              opt.value = student.id;
              opt.textContent = student.username;
              filterSelect.appendChild(opt);
            }
          });
        } else {
          if (noClientsMsg) noClientsMsg.style.display = 'flex';
          grid.innerHTML = '';
        }

        lucide.createIcons();

        // Show FAB only if there are active students
        const coachChatFab = document.getElementById('coach-chat-fab');
        if (coachChatFab) {
          if (students.length > 0) {
            coachChatFab.classList.remove('hidden');
          } else {
            coachChatFab.classList.add('hidden');
          }
        }
      } catch (err) {
        console.error('Fetch students error:', err);
      }
    }

    let studentChart = null;

    async function handleAnalyticsFilterChange() {
      const val = document.getElementById('analytics-filter').value;
      const overallView = document.getElementById('overall-analytics-view');
      const studentView = document.getElementById('student-analytics-view');

      if (val === 'overall') {
        overallView.classList.remove('hidden');
        studentView.classList.add('hidden');
        initCharts(); // Refresh aggregate charts
      } else {
        overallView.classList.add('hidden');
        studentView.classList.remove('hidden');
        loadStudentAnalytics(val);
      }
    }

    async function loadStudentAnalytics(studentId) {
      try {
        const res = await fetch(`/api/coach/student/${studentId}/analytics`);
        if (!res.ok) throw new Error('Failed to fetch student details');
        const data = await res.json();

        // 1. Productivity Score
        const productivity = data.totalTasks > 0 ? Math.round((data.tasksCompleted / data.totalTasks) * 100) : 0;
        document.getElementById('student-productivity-badge').textContent = `Productivity: ${productivity}%`;

        // 2. Goal Progress Bars
        const goalsList = document.getElementById('individual-goals-list');
        goalsList.innerHTML = '';
        if (data.goals.length === 0) {
          goalsList.innerHTML = `
            <div class="flex flex-col items-center justify-center py-8 text-center">
              <div class="w-12 h-12 bg-slate-50 text-slate-200 rounded-2xl flex items-center justify-center mb-3">
                <i data-lucide="target" class="w-6 h-6"></i>
              </div>
              <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">No goals set yet</p>
            </div>`;
        } else {
          data.goals.forEach(goal => {
            const prog = goal.total > 0 ? Math.round((goal.spent / goal.total) * 100) : 0;
            goalsList.insertAdjacentHTML('beforeend', `
              <div class="group">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-xs font-black text-slate-700 uppercase tracking-tight">${goal.title || goal.category}</span>
                  <span class="text-xs font-black text-indigo-600">${prog}%</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden shadow-inner">
                  <div class="bg-indigo-600 h-full rounded-full transition-all duration-1000 shadow-[0_0_8px_rgba(99,102,241,0.3)]" style="width: ${prog}%"></div>
                </div>
                <div class="flex justify-between mt-2">
                  <span class="text-[10px] font-bold text-slate-400 capitalize">Efficiency Level</span>
                  <span class="text-[10px] font-black text-slate-500">â‚¹${goal.spent} / â‚¹${goal.total}</span>
                </div>
              </div>
            `);
          });
        }

        // 3. Activity Chart
        const ctx = document.getElementById('individualTaskChart').getContext('2d');
        if (studentChart) studentChart.destroy();

        const labels = data.taskHistory.map(h => {
          const d = new Date(h.date);
          return d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
        });
        const values = data.taskHistory.map(h => h.count);

        studentChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels.length > 0 ? labels : ['No Data'],
            datasets: [{
              label: 'Daily Tasks Completed',
              data: values.length > 0 ? values : [0],
              borderColor: '#6366f1',
              backgroundColor: 'rgba(99, 102, 241, 0.05)',
              borderWidth: 4,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#fff',
              pointBorderColor: '#6366f1',
              pointBorderWidth: 3,
              pointRadius: 5,
              pointHoverRadius: 7
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1e293b',
                titleFont: { size: 12, weight: '900' },
                bodyFont: { size: 12, weight: 'bold' },
                padding: 12,
                cornerRadius: 12,
                displayColors: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: '#f1f5f9' },
                ticks: { stepSize: 1, font: { weight: 'bold' } }
              },
              x: {
                grid: { display: false },
                ticks: { font: { weight: 'bold' } }
              }
            }
          }
        });

        // 4. Activity Summary
        const tasksDiv = document.getElementById('individual-recent-tasks');
        tasksDiv.innerHTML = `
          <div class="flex flex-col md:flex-row items-center gap-6 bg-slate-50 p-6 rounded-3xl border border-slate-100">
             <div class="w-16 h-16 bg-white rounded-2xl shadow-sm flex items-center justify-center text-amber-500 shrink-0 border border-slate-100">
               <i data-lucide="award" class="w-8 h-8"></i>
             </div>
             <div class="flex-1 text-center md:text-left">
                <h4 class="text-lg font-black text-slate-800 mb-1">Productivity Insight</h4>
                <p class="text-sm text-slate-500 font-medium leading-relaxed">This client has maintained a consistent pace, completing a total of <span class="text-indigo-600 font-black">${data.tasksCompleted} tasks</span>. Their engagement remains high across all active goals.</p>
             </div>
             <div class="px-6 py-3 bg-white rounded-2xl border border-slate-100 shadow-sm text-center min-w-[120px]">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Total Items</p>
                <p class="text-2xl font-black text-slate-800">${data.tasksCompleted}</p>
             </div>
          </div>
        `;
        lucide.createIcons();

      } catch (err) {
        console.error(err);
      }
    }

    function viewStudentDetails(studentId) {
      // Switch to Analytics Tab
      const analyticsBtn = document.querySelector('[data-tab="analytics"]');
      if (analyticsBtn) analyticsBtn.click();

      // Set filter and trigger change
      const filter = document.getElementById('analytics-filter');
      if (filter) {
        filter.value = studentId;
        handleAnalyticsFilterChange();
      }
    }
    function openChatWithStudent(id, name) {
      const overlay = document.getElementById('coach-chat-overlay');
      if (overlay && !overlay.classList.contains('opacity-100')) {
        toggleCoachChat();
      }
      selectChatUser({ id, username: name });
    }

    // ARTICLE FORM LOGIC
    function initArticleForm() {
      const form = document.getElementById('articleForm');
      if (!form) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="animate-spin" data-lucide="loader"></i> Publishing...';
        lucide.createIcons();

        const imgPreview = document.getElementById('image-preview');
        const imageUrl = imgPreview && imgPreview.src.startsWith('data:') ? imgPreview.src : null;

        // Basic data collection
        const data = {
          title: document.getElementById('articleTitle').value,
          description: document.getElementById('articleDescription').value,
          content: document.getElementById('articleContent').value,
          slug: document.getElementById('slug').value,
          category: document.getElementById('category').value,
          imageUrl: imageUrl || `https://source.unsplash.com/random/800x600/?${document.getElementById('category').value}`,
          status: 'published' // Auto-publish for now
        };

        try {
          const res = await fetch('/api/articles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Failed to publish');
          }

          const result = await res.json();
          alert('Article published successfully!');
          const removeBtn = document.getElementById('remove-image');
          if (removeBtn) removeBtn.click();
          form.reset();
        } catch (err) {
          console.error(err);
          alert('Error: ' + err.message);
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
          lucide.createIcons();
        }
      });
    }

    function initArticleImageUpload() {
      const dropZone = document.getElementById('imageUpload');
      const fileInput = document.getElementById('featuredImage');
      const placeholder = document.getElementById('image-placeholder');
      const previewContainer = document.getElementById('image-preview-container');
      const previewImg = document.getElementById('image-preview');
      const removeBtn = document.getElementById('remove-image');

      if (!dropZone || !fileInput) return;

      dropZone.addEventListener('click', (e) => {
        if (e.target.closest('#remove-image')) return;
        fileInput.click();
      });

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleImageFile(file);
      });

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('bg-indigo-50', 'border-indigo-400');
      });

      ['dragleave', 'drop'].forEach(name => {
        dropZone.addEventListener(name, () => {
          dropZone.classList.remove('bg-indigo-50', 'border-indigo-400');
        });
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          handleImageFile(file);
        }
      });

      removeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        fileInput.value = '';
        previewImg.src = '';
        previewContainer.classList.add('hidden');
        placeholder.classList.remove('hidden');
      });

      function handleImageFile(file) {
        if (file.size > 5 * 1024 * 1024) {
          alert('Image too large. Max 5MB.');
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          placeholder.classList.add('hidden');
          previewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    }

    // CLIENT VIEW LOGIC
    function viewClient(name, imgSrc) {
      // Hide all main tab panels
      document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
      // Hide Tabs Nav to focus on client view (optional, but cleaner)
      // document.getElementById('tabs').style.display = 'none'; 

      // Show Detail View
      const view = document.getElementById('client-detail-view');
      view.classList.remove('hidden');

      // Populate Data
      document.getElementById('detail-client-name').textContent = name;
      if (imgSrc) document.getElementById('detail-client-img').src = imgSrc;

      // Re-run icons for new content if needed (though static here)
      lucide.createIcons();
    }

    function closeClientView() {
      // Hide Detail View
      document.getElementById('client-detail-view').classList.add('hidden');

      // Show Active Tab (Users by default or last active)
      // Simplest: Just trigger click on active tab button
      const activeBtn = document.querySelector('.tab-btn.active');
      if (activeBtn) {
        // Restore display check handled by initTabs click logic? 
        // Actually our initTabs toggles class 'active', but we manually set style.display='none' above.
        // Let's reset styles:
        document.querySelectorAll('.tab-panel').forEach(p => p.style.display = '');
        // Display the active one
        document.querySelectorAll('.tab-panel').forEach(p => {
          p.classList.remove('active'); // reset
        });
        const targetId = `tab-${activeBtn.dataset.tab}`;
        document.getElementById(targetId).classList.add('active');
      }
    }

    // AUTH CHECK - Removed inline checkAuth as auth-helper.js now handles this globally.

    // TAB LOGIC matching app.html
    function initTabs() {
      const btns = document.querySelectorAll('.tab-btn, .dropdown-item[data-tab]');
      const panels = document.querySelectorAll('.tab-panel');

      const updateVisibility = (targetId) => {
        panels.forEach(p => {
          if (p.id === `tab-${targetId}`) {
            p.style.display = 'block';
            p.classList.add('active');
          } else {
            p.style.display = 'none';
            p.classList.remove('active');
          }
        });
      };

      btns.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.tab;
          if (!target) return;

          // Update Active States for Navbar Buttons (not dropdown items)
          if (btn.classList.contains('tab-btn')) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          } else {
            // If from dropdown, remove active from all navbar buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          }

          updateVisibility(target);
          if (target === 'messages') {
            initCoachChat();
          }

          // Close dropdown if it was a dropdown item
          if (btn.classList.contains('dropdown-item')) {
            document.getElementById('coach-profile-dropdown')?.classList.remove('show');
            document.getElementById('nav-profile-chevron')?.classList.remove('rotate-180');
          }
        });
      });

      // Dropdown Toggle Logic
      const profileBtn = document.getElementById('coach-profile-btn');
      const profileDropdown = document.getElementById('coach-profile-dropdown');
      const profileChevron = document.getElementById('nav-profile-chevron');

      if (profileBtn && profileDropdown) {
        profileBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          profileDropdown.classList.toggle('show');
          profileChevron?.classList.toggle('rotate-180');
        });

        document.addEventListener('click', (e) => {
          if (!profileDropdown.contains(e.target) && !profileBtn.contains(e.target)) {
            profileDropdown.classList.remove('show');
            profileChevron?.classList.remove('rotate-180');
          }
        });
      }

      // Initialize state based on active button
      const activeBtn = document.querySelector('.tab-btn.active');
      if (activeBtn) {
        updateVisibility(activeBtn.dataset.tab);
      }
    }

    // PROFILE FETCH
    async function fetchProfile() {
      try {
        const res = await fetch('/api/coach/me', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to fetch profile');
        const data = await res.json();

        // Status-based logic
        if (data.status === 'pending_onboarding') {
          window.location.replace('onboarding.html');
          return;
        }

        if (data.status === 'pending') {
          // Show overlay or message? 
          // For now, let's just add a notice bar at the top
          const notice = document.createElement('div');
          notice.className = 'bg-yellow-100 border-b border-yellow-200 text-yellow-800 px-4 py-2 text-center text-sm font-medium';
          notice.innerHTML = '<i class="fas fa-clock mr-2"></i> Your profile is currently pending admin approval. Some features may be limited.';
          document.body.prepend(notice);
        }

        document.getElementById('profile-name').textContent = data.name || data.email;

        // Update Navbar Avatar
        const navImgContainer = document.getElementById('nav-profile-img-container');
        if (navImgContainer) {
          const photoUrl = data.profile_photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.name || 'C')}&background=6366f1&color=fff`;
          navImgContainer.innerHTML = `<img src="${photoUrl}" class="w-full h-full object-cover">`;
        }

        document.getElementById('profile-email').textContent = data.email;
        document.getElementById('profile-bio').textContent = data.bio || 'Professional Coach';
        document.getElementById('profile-category').textContent = data.coach_type || 'General';
        document.getElementById('profile-experience').textContent = data.years_experience ? `${data.years_experience} Years` : 'Not specified';
        document.getElementById('profile-hours').textContent = data.hours_coached ? `${Number(data.hours_coached).toLocaleString()} hrs` : '0 hrs';

        if (data.profile_photo) {
          document.getElementById('profile-img').src = data.profile_photo;
        } else {
          document.getElementById('profile-img').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(data.name || 'Coach')}&background=random`;
        }

        // Update coachInfo if missing (for chat identification)
        if (!coachInfo || !coachInfo.id) {
          coachInfo = data;
          if (chatSocket && chatSocket.connected) {
            const idToIdentify = coachInfo.id || coachInfo.userId;
            chatSocket.emit('identify', { coachId: idToIdentify, userType: 'coach' });
          }
        }
      } catch (e) {
        console.error(e);
        window.location.replace('../../coach-login.html');
      }
    }

    // LOGOUT
    document.getElementById('logoutBtn').addEventListener('click', () => {
      AuthHelper.logout();
    });

    // CHARTS (Real Data)
    async function initCharts() {
      // Defaults to match app style
      Chart.defaults.font.family = "'Inter', system-ui, sans-serif";
      Chart.defaults.font.weight = '700';
      Chart.defaults.color = '#94a3b8';

      try {
        const res = await fetch('/api/coach/analytics');
        if (!res.ok) throw new Error('Failed to fetch coach analytics');
        const data = await res.json();

        const actCtx = document.getElementById('activityChart')?.getContext('2d');
        if (actCtx) {
          const labels = data.performance.map(p => p.month);

          new Chart(actCtx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Tasks Completed',
                data: data.performance.map(p => p.count),
                backgroundColor: '#6366f1',
                borderRadius: 8,
                barThickness: 24
              },
              {
                label: 'Goals Active',
                data: data.goalPerformance ? data.goalPerformance.map(p => p.count) : [],
                backgroundColor: '#10b981',
                borderRadius: 8,
                barThickness: 24
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  align: 'end',
                  labels: {
                    boxWidth: 8,
                    boxHeight: 8,
                    usePointStyle: true,
                    pointStyle: 'circle',
                    padding: 20,
                    font: { size: 11, weight: 'bold' }
                  }
                },
                tooltip: {
                  backgroundColor: '#1e293b',
                  padding: 12,
                  cornerRadius: 12,
                  titleFont: { size: 12, weight: '900' },
                  bodyFont: { size: 12, weight: 'bold' }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: '#f8fafc', drawBorder: false },
                  ticks: { font: { weight: 'bold' } }
                },
                x: {
                  grid: { display: false },
                  ticks: { font: { weight: 'bold' } }
                }
              }
            }
          });
        }

        const growthCtx = document.getElementById('growthChart')?.getContext('2d');
        if (growthCtx) {
          new Chart(growthCtx, {
            type: 'line',
            data: {
              labels: data.growth.map(g => g.month),
              datasets: [{
                label: 'New Clients',
                data: data.growth.map(g => g.count),
                borderColor: '#10b981',
                borderWidth: 4,
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(16, 185, 129, 0.05)',
                pointBackgroundColor: '#fff',
                pointBorderColor: '#10b981',
                pointBorderWidth: 3,
                pointRadius: 5
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: '#1e293b',
                  padding: 12,
                  cornerRadius: 12
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: '#f8fafc', drawBorder: false },
                  ticks: { font: { weight: 'bold' } }
                },
                x: {
                  grid: { display: false },
                  ticks: { font: { weight: 'bold' } }
                }
              }
            }
          });
        }
      } catch (err) {
        console.error('Error initializing charts:', err);
      }
    }

    /* ---------------- COACH DASHBOARD INITIALIZATION ---------------- */
    async function initDashboard() {
      await fetchCoachProfile();
      initCharts();
      loadPendingRequests();
    }

    document.addEventListener('DOMContentLoaded', initDashboard);
  </script>
  <script src="app.js"></script>
</body>
/* ---------------- APPROVALS LOGIC ---------------- */
async function loadPendingRequests() {
const list = document.getElementById('approvals-list');
const emptyMsg = document.getElementById('approvals-empty');
const countBadge = document.getElementById('approval-count');

if (!list) return;

try {
const res = await fetch('/api/coach/pending-requests');
if (!res.ok) throw new Error('Failed to fetch requests');
const requests = await res.json();

// Update badge
if (countBadge) {
countBadge.textContent = requests.length;
if (requests.length > 0) countBadge.classList.remove('hidden');
else countBadge.classList.add('hidden');
}

if (requests.length === 0) {
list.innerHTML = `
<div class="flex flex-col items-center justify-center p-8 text-center opacity-50 space-y-2">
  <i data-lucide="ghost" class="w-8 h-8 text-slate-300"></i>
  <p class="text-[10px] font-black uppercase text-slate-400">No pending requests</p>
</div>`;
lucide.createIcons();
emptyMsg.classList.remove('hidden');
return;
}

emptyMsg.classList.add('hidden');
list.innerHTML = '';

requests.forEach(req => {
const card = document.createElement('div');
card.className = 'glass-card p-6 rounded-[1.5rem] border border-slate-100 flex flex-col gap-6 fade-in';

const reqDate = req.requested_time ? new Date(req.requested_time).toLocaleString() : 'Flexible';
const userPhoto = req.user_photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(req.user_name_input ||
req.username)}&background=random`;

card.innerHTML = `
<div class="flex flex-col md:flex-row gap-6">
  <!-- User Info -->
  <div class="flex items-start gap-4 min-w-[200px]">
    <img src="${userPhoto}" class="w-16 h-16 rounded-2xl object-cover shadow-sm border-2 border-white bg-slate-100"
      onerror="this.src='https://ui-avatars.com/api/?name=User&background=random'">
    <div>
      <h4 class="font-black text-slate-800 text-lg">${req.user_name_input || req.username}</h4>
      <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">${req.booking_category || 'General'}</p>
      <div
        class="inline-flex items-center px-2 py-1 rounded-lg bg-indigo-50 text-indigo-700 text-[10px] font-black uppercase tracking-widest">
        ${req.session_type || '1:1 Session'}
      </div>
    </div>
  </div>

  <!-- Request Details -->
  <div class="flex-1 space-y-4">
    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
      <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Goal / Reason</p>
      <p class="text-sm text-slate-600 leading-relaxed font-medium">"${req.booking_goal || 'No details provided'}"</p>
    </div>

    <div class="flex flex-wrap gap-4">
      <div class="flex items-center gap-2 text-slate-500 text-xs font-bold">
        <i data-lucide="calendar" class="w-4 h-4 text-indigo-500"></i>
        <span>Requested: <span class="text-slate-700">${reqDate}</span></span>
      </div>
      <div class="flex items-center gap-2 text-slate-500 text-xs font-bold">
        <i data-lucide="globe" class="w-4 h-4 text-purple-500"></i>
        <span>${req.user_timezone || 'UTC'}</span>
      </div>
    </div>
  </div>

  <!-- Actions: View Profile Only -->
  <div class="flex flex-col gap-2 min-w-[140px] justify-center">
    <button onclick="viewUserProfile(${req.user_id})"
      class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-xs font-black uppercase tracking-widest transition-all shadow-lg shadow-indigo-200 flex items-center justify-center gap-2">
      <i data-lucide="eye" class="w-4 h-4"></i> View Profile
    </button>
  </div>
</div>
`;
list.appendChild(card);
});
lucide.createIcons();

} catch (e) {
console.error("Error loading requests:", e);
}
}

// View User Profile Modal
async function viewUserProfile(userId) {
try {
const res = await fetch(`/api/coach/user-profile/${userId}`);
if (!res.ok) throw new Error('Failed to load profile');
const data = await res.json();

const { user, booking, stats, goals, recentTasks } = data;
const userPhoto = booking.user_photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(booking.user_name_input
|| user.username)}&background=6366f1&color=fff&size=128`;
const completionRate = stats.totalTasks > 0 ? Math.round((stats.completedTasks / stats.totalTasks) * 100) : 0;
const memberSince = new Date(user.created_at).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
const reqDate = booking.requested_time ? new Date(booking.requested_time).toLocaleString() : 'Flexible';

// Build goals HTML
let goalsHtml = '';
if (goals.length > 0) {
goalsHtml = goals.map(g => `
<div class="flex items-center gap-3 py-2">
  <div class="w-2 h-2 rounded-full ${g.status === 'completed' ? 'bg-green-400' : 'bg-indigo-400'}"></div>
  <span class="text-sm text-slate-700 font-medium flex-1">${g.title}</span>
  <span
    class="text-[10px] uppercase font-bold tracking-wider ${g.status === 'completed' ? 'text-green-500' : 'text-indigo-500'}">${g.status
    || 'active'}</span>
</div>
`).join('');
} else {
goalsHtml = '<p class="text-sm text-slate-400 italic">No goals set yet</p>';
}

// Build recent tasks HTML
let tasksHtml = '';
if (recentTasks.length > 0) {
tasksHtml = recentTasks.map(t => `
<div class="flex items-center gap-3 py-2">
  <div
    class="w-5 h-5 rounded-md flex items-center justify-center ${t.done ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-400'}">
    <i data-lucide="${t.done ? 'check' : 'circle'}" class="w-3 h-3"></i>
  </div>
  <span
    class="text-sm text-slate-700 font-medium flex-1 ${t.done ? 'line-through text-slate-400' : ''}">${t.task}</span>
  <span class="text-[10px] uppercase font-bold tracking-wider text-slate-400">${t.category || ''}</span>
</div>
`).join('');
} else {
tasksHtml = '<p class="text-sm text-slate-400 italic">No tasks yet</p>';
}

// Create modal
const existingModal = document.getElementById('userProfileModal');
if (existingModal) existingModal.remove();

const modal = document.createElement('div');
modal.id = 'userProfileModal';
modal.className = 'fixed inset-0 z-[100] flex items-center justify-center';
modal.innerHTML = `
<!-- Backdrop -->
<div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeUserProfileModal()"></div>

<!-- Modal -->
<div
  class="relative z-10 bg-white rounded-[2rem] shadow-2xl border border-slate-100 w-full max-w-2xl max-h-[90vh] overflow-y-auto mx-4">

  <!-- Header -->
  <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 rounded-t-[2rem] relative">
    <button onclick="closeUserProfileModal()"
      class="absolute top-4 right-4 text-white/60 hover:text-white transition-colors">
      <i data-lucide="x" class="w-6 h-6"></i>
    </button>
    <div class="flex items-center gap-6">
      <img src="${userPhoto}" class="w-20 h-20 rounded-2xl object-cover border-4 border-white/30 shadow-lg"
        onerror="this.src='https://ui-avatars.com/api/?name=User&background=random'">
      <div>
        <h2 class="text-2xl font-black text-white">${booking.user_name_input || user.username}</h2>
        <p class="text-indigo-200 text-sm font-bold">${user.email}</p>
        <p class="text-indigo-300 text-xs font-bold mt-1">Member since ${memberSince}</p>
      </div>
    </div>
  </div>

  <!-- Stats Row -->
  <div class="grid grid-cols-3 gap-4 p-6 -mt-4">
    <div class="bg-white rounded-2xl p-4 shadow-lg border border-slate-100 text-center">
      <p class="text-2xl font-black text-indigo-600">${stats.totalTasks}</p>
      <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Tasks</p>
    </div>
    <div class="bg-white rounded-2xl p-4 shadow-lg border border-slate-100 text-center">
      <p class="text-2xl font-black text-green-600">${completionRate}%</p>
      <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Completion</p>
    </div>
    <div class="bg-white rounded-2xl p-4 shadow-lg border border-slate-100 text-center">
      <p class="text-2xl font-black text-purple-600">${stats.totalGoals}</p>
      <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Goals</p>
    </div>
  </div>

  <!-- Booking Details -->
  <div class="px-6 pb-4">
    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Booking Request</h3>
    <div class="bg-indigo-50 rounded-2xl p-5 border border-indigo-100 space-y-3">
      <div>
        <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1">Goal / Reason</p>
        <p class="text-sm text-slate-700 font-medium">"${booking.booking_goal || 'No details provided'}"</p>
      </div>
      <div class="flex flex-wrap gap-4 text-xs font-bold">
        <span class="inline-flex items-center gap-1.5 text-slate-500"><i data-lucide="tag"
            class="w-3.5 h-3.5 text-indigo-500"></i> ${booking.booking_category || 'General'}</span>
        <span class="inline-flex items-center gap-1.5 text-slate-500"><i data-lucide="users"
            class="w-3.5 h-3.5 text-indigo-500"></i> ${booking.session_type || '1:1'}</span>
        <span class="inline-flex items-center gap-1.5 text-slate-500"><i data-lucide="calendar"
            class="w-3.5 h-3.5 text-indigo-500"></i> ${reqDate}</span>
        <span class="inline-flex items-center gap-1.5 text-slate-500"><i data-lucide="globe"
            class="w-3.5 h-3.5 text-indigo-500"></i> ${booking.user_timezone || 'UTC'}</span>
      </div>
    </div>
  </div>

  <!-- Goals -->
  <div class="px-6 pb-4">
    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Goals</h3>
    <div class="bg-white rounded-2xl p-4 border border-slate-100">${goalsHtml}</div>
  </div>

  <!-- Recent Tasks -->
  <div class="px-6 pb-4">
    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Recent Tasks</h3>
    <div class="bg-white rounded-2xl p-4 border border-slate-100">${tasksHtml}</div>
  </div>

  <!-- Action Buttons -->
  <div class="px-6 pb-8 flex gap-3">
    <button onclick="respondToRequest(${userId}, 'approve')"
      class="flex-1 py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl text-sm font-black uppercase tracking-widest transition-all shadow-lg shadow-indigo-200 flex items-center justify-center gap-2">
      <i data-lucide="check-circle" class="w-5 h-5"></i> Approve
    </button>
    <button onclick="respondToRequest(${userId}, 'reject')"
      class="flex-1 py-4 bg-white border-2 border-slate-200 text-slate-500 hover:bg-red-50 hover:text-red-600 hover:border-red-200 rounded-2xl text-sm font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2">
      <i data-lucide="x-circle" class="w-5 h-5"></i> Decline
    </button>
  </div>
</div>
`;

document.body.appendChild(modal);
lucide.createIcons();

} catch (e) {
console.error("Error loading profile:", e);
alert('Failed to load user profile');
}
}

function closeUserProfileModal() {
const modal = document.getElementById('userProfileModal');
if (modal) modal.remove();
}

async function respondToRequest(userId, action) {
if (!confirm(`Are you sure you want to ${action} this request?`)) return;

try {
const res = await fetch('/api/coach/respond-request', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ userId, action })
});

if (!res.ok) throw new Error('Failed to update request');

// Close profile modal if open
closeUserProfileModal();

// Refresh list
loadPendingRequests();

// Update stats/clients if approved
if (action === 'approve') {
fetchStudents();
}
} catch (e) {
alert('Error: ' + e.message);
}
}

// Auto-load approvals count
loadPendingRequests();

// Tab listener
document.querySelector('[data-tab="approvals"]')?.addEventListener('click', loadPendingRequests);

</script>
</body>

</html>