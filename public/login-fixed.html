<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login | PlanIT</title>
  <script src="/js/auth-helper.js"></script>
  <meta name="description" content="Log in to access your PlannIt account. Your data stays private and secure.">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="./css/styles.css?v=role1">
  <style>
    .login-bg {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      min-height: 100vh;
    }
  </style>
</head>

<body>
  <div class="min-h-screen flex flex-col">
    <!-- Simple header with back button -->
    <header class="bg-white shadow-sm">
      <div class="max-w-5xl mx-auto px-4 py-4 flex items-center">
        <a href="./landing.html" class="flex items-center gap-2 text-indigo-600 hover:text-indigo-800">
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
          <span>Back to home</span>
        </a>
      </div>
    </header>

    <main class="flex-grow flex items-center justify-center p-4">
      <div class="w-full max-w-md">
        <!-- Logo and title -->
        <div class="text-center mb-8">
          <h1 class="text-2xl font-bold text-gray-900">Welcome back</h1>
          <p class="mt-1 text-gray-600">Sign in to continue to Planexa</p>
        </div>

        <!-- Login form -->
        <div class="bg-white rounded-xl shadow-sm p-8">
          <form id="loginForm" class="space-y-6">

            <!-- Email -->
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i data-lucide="mail" class="h-5 w-5 text-gray-400"></i>
                </div>
                <input id="email" name="email" type="email" autocomplete="email" required
                  class="appearance-none block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                  placeholder="you@example.com">
              </div>
            </div>

            <!-- Password -->
            <div>
              <div class="flex items-center justify-between mb-1">
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <a href="#" id="forgot-password-link" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
                  Forgot password?
                </a>
              </div>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i data-lucide="lock" class="h-5 w-5 text-gray-400"></i>
                </div>
                <input id="password" name="password" type="password" autocomplete="current-password" required
                  class="appearance-none block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                  placeholder="••••••••">
              </div>
            </div>

            <!-- Remember me -->
            <div class="flex items-center">
              <input id="remember-me" name="remember-me" type="checkbox"
                class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
              <label for="remember-me" class="ml-2 block text-sm text-gray-700">
                Remember me
              </label>
            </div>
          </form>

          <div class="mt-4">
            <button type="submit" form="loginForm"
              class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
              <i data-lucide="log-in" class="w-4 h-4 mr-2"></i>
              Continue
            </button>
          </div>

          <div class="mt-6">
            <button id="show-register" type="button"
              class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
              <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
              Create account
            </button>
          </div>
        </div>

        <!-- Registration form (hidden by default) -->
        <div id="register-form" class="bg-white rounded-xl shadow-sm p-8 hidden">
          <div class="mb-6">
            <button id="back-to-login" type="button"
              class="flex items-center gap-2 text-indigo-600 hover:text-indigo-500">
              <i data-lucide="arrow-left" class="w-4 h-4"></i>
              Back to login
            </button>
          </div>

          <form id="registerForm" class="space-y-6">
            <div>
              <label for="reg-user-type" class="block text-sm font-medium text-gray-700 mb-1">I am a</label>
              <div class="relative mb-4">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i data-lucide="users" class="h-5 w-5 text-gray-400"></i>
                </div>
                <select id="reg-user-type" name="userType" required
                  class="appearance-none block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white">
                  <option value="user" selected>User</option>
                </select>
              </div>

              <label for="reg-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i data-lucide="user" class="h-5 w-5 text-gray-400"></i>
                </div>
                <input id="reg-username" name="username" type="text" required
                  class="appearance-none block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                  placeholder="yourname">
              </div>
              <!-- Username Requirements UI -->
              <div id="username-requirements" class="mt-2 text-xs text-gray-500 space-y-1 hidden">
                <p class="font-semibold mb-1">Username rules:</p>
                <div id="u-rule-length" class="flex items-center gap-2"><i data-lucide="circle" class="w-3 h-3"></i>
                  3-20 characters</div>
                <div id="u-rule-chars" class="flex items-center gap-2"><i data-lucide="circle" class="w-3 h-3"></i> a-z,
                  0-9, . _ (lowercase only)</div>
                <div id="u-rule-format" class="flex items-center gap-2"><i data-lucide="circle" class="w-3 h-3"></i> No
                  start/end symbols, no spaces</div>
                <div id="u-rule-consecutive" class="flex items-center gap-2"><i data-lucide="circle"
                    class="w-3 h-3"></i> No .. or __</div>
                <div id="u-rule-reserved" class="flex items-center gap-2"><i data-lucide="circle" class="w-3 h-3"></i>
                  Not reserved word</div>
              </div>
            </div>

            <div>
              <label for="reg-email" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i data-lucide="mail" class="h-5 w-5 text-gray-400"></i>
                </div>
                <input id="reg-email" name="email" type="email" required
                  class="appearance-none block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                  placeholder="you@example.com">
              </div>
            </div>

            <div>
              <label for="reg-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i data-lucide="lock" class="h-5 w-5 text-gray-400"></i>
                </div>
                <input id="reg-password" name="password" type="password" required
                  class="appearance-none block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                  placeholder="••••••••">
              </div>
              <!-- Password Requirements UI -->
              <div id="password-requirements" class="mt-2 text-xs text-gray-500 space-y-1 hidden">
                <p class="font-semibold mb-1">Password must match rules:</p>
                <div id="rule-length" class="flex items-center gap-2"><i data-lucide="circle" class="w-3 h-3"></i> At
                  least 8 characters</div>
                <div id="rule-uppercase" class="flex items-center gap-2"><i data-lucide="circle" class="w-3 h-3"></i>
                  One uppercase letter</div>
                <div id="rule-lowercase" class="flex items-center gap-2"><i data-lucide="circle" class="w-3 h-3"></i>
                  One lowercase letter</div>
              </div>
            </div>

            <div>
              <button type="submit"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
                Create account
              </button>
            </div>
          </form>
        </div>

        <!-- Forgot Password form (hidden by default) -->
        <div id="forgot-password-form" class="bg-white rounded-xl shadow-sm p-8 hidden">
          <div class="mb-6">
            <button id="back-to-login-forgot" type="button"
              class="flex items-center gap-2 text-indigo-600 hover:text-indigo-500">
              <i data-lucide="arrow-left" class="w-4 h-4"></i>
              Back to login
            </button>
          </div>

          <h2 class="text-xl font-bold text-gray-900 mb-4">Reset Password</h2>

          <!-- Step 1: Request OTP -->
          <form id="requestOtpForm" class="space-y-6">
            <div>
              <label for="reset-email" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i data-lucide="mail" class="h-5 w-5 text-gray-400"></i>
                </div>
                <input id="reset-email" name="email" type="email" required
                  class="appearance-none block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                  placeholder="you@example.com">
              </div>
            </div>
            <button type="submit"
              class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
              Send OTP Code
            </button>
          </form>

          <!-- Step 2: Verify OTP & Reset (Hidden initially) -->
          <form id="resetPasswordForm" class="space-y-6 hidden mt-6 pt-6 border-t border-gray-100">
            <div class="bg-blue-50 text-blue-800 p-3 rounded-lg text-sm mb-4">
              Enter the OTP sent to your email. Check console if testing locally.
            </div>

            <input type="hidden" id="reset-email-confirm">

            <div>
              <label for="otp-code" class="block text-sm font-medium text-gray-700 mb-1">OTP Code</label>
              <input id="otp-code" name="otp" type="text" required placeholder="123456"
                class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm tracking-widest text-center font-mono text-lg">
            </div>

            <div>
              <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i data-lucide="lock" class="h-5 w-5 text-gray-400"></i>
                </div>
                <input id="new-password" name="newPassword" type="password" required
                  class="appearance-none block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                  placeholder="••••••••">
              </div>
            </div>

            <button type="submit"
              class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
              Reset Password
            </button>
          </form>
        </div>
      </div>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();

      const API_BASE = 'http://localhost:3000';
      const NAME_KEY = 'planner.user';

      <!-- Redundant manual redirect replaced by auth-helper.js -->

      // PRE-FILL REMEMBERED EMAIL
      const rememberedEmail = localStorage.getItem('planner.rememberedEmail');
      if (rememberedEmail) {
        const emailInput = document.getElementById('email');
        if (emailInput) {
          emailInput.value = rememberedEmail;
          const rememberMeCheckbox = document.getElementById('remember-me');
          if (rememberMeCheckbox) rememberMeCheckbox.checked = true;
        }
      }

      // ---------------------------
      // ELEMENTS
      // ---------------------------
      const loginForm = document.getElementById('loginForm');
      const emailEl = document.getElementById('email');
      const passEl = document.getElementById('password');
      const rememberMeEl = document.getElementById('remember-me');
      const demoLoginBtn = document.getElementById('demo-login');

      const showRegisterBtn = document.getElementById('show-register');
      const backToLoginBtn = document.getElementById('back-to-login');

      const loginBox = document.getElementById('loginForm').closest('.bg-white');
      const registerBox = document.getElementById('register-form');

      const registerForm = document.getElementById('registerForm');
      const regUsername = document.getElementById('reg-username');
      const usernameRequirements = document.getElementById('username-requirements');

      // Username Validation Logic
      function validateUsername(username) {
        const u = username;
        const rules = {
          length: u.length >= 3 && u.length <= 20,
          chars: /^[a-z0-9._]+$/.test(u), // Only allowed chars
          format: /^[a-z0-9](.*[a-z0-9])?$/.test(u), // Start/End with letter/num
          consecutive: !/(\.\.|__)/.test(u),
          reserved: !['admin', 'support', 'system', 'root'].includes(u)
        };
        return rules;
      }

      function updateUsernameUI(rules) {
        usernameRequirements.classList.remove('hidden');
        const updateItem = (id, isValid) => {
          const el = document.getElementById(id);
          const icon = el.querySelector('i');
          if (isValid) {
            el.classList.remove('text-gray-500', 'text-red-500');
            el.classList.add('text-green-600');
            icon.setAttribute('data-lucide', 'check-circle');
          } else {
            el.classList.remove('text-green-600');
            el.classList.add('text-gray-500');
            icon.setAttribute('data-lucide', 'circle');
          }
        };

        updateItem('u-rule-length', rules.length);
        updateItem('u-rule-chars', rules.chars);
        updateItem('u-rule-format', rules.format);
        updateItem('u-rule-consecutive', rules.consecutive);
        updateItem('u-rule-reserved', rules.reserved);

        if (window.lucide) lucide.createIcons();
      }

      regUsername.addEventListener('input', () => {
        // Auto-convert to lowercase? Or just validate? 
        // User asked "Only lowercase allowed", implying we should enforce it. 
        // Let's validate it, maybe user typed Capital. 
        // Actually, let's allow typing but show error.
        const rules = validateUsername(regUsername.value);
        updateUsernameUI(rules);
      });

      regUsername.addEventListener('focus', () => {
        usernameRequirements.classList.remove('hidden');
      });

      const regEmail = document.getElementById('reg-email');

      const regPassword = document.getElementById('reg-password');
      const passwordRequirements = document.getElementById('password-requirements');

      // Password Validation Logic
      function validatePassword(password) {
        const rules = {
          length: password.length >= 8,
          uppercase: /[A-Z]/.test(password),
          lowercase: /[a-z]/.test(password)
        };
        return rules;
      }

      function updatePasswordUI(rules) {
        passwordRequirements.classList.remove('hidden');

        const updateItem = (id, isValid) => {
          const el = document.getElementById(id);
          if (!el) return; // FIX: Prevents null pointer error
          const icon = el.querySelector('i');
          if (!icon) return; // FIX: Extra safety

          if (isValid) {
            el.classList.remove('text-gray-500', 'text-red-500');
            el.classList.add('text-green-600');
            icon.setAttribute('data-lucide', 'check-circle');
          } else {
            el.classList.remove('text-green-600');
            el.classList.add('text-gray-500');
            icon.setAttribute('data-lucide', 'circle');
          }
        };

        updateItem('rule-length', rules.length);
        updateItem('rule-uppercase', rules.uppercase);
        updateItem('rule-lowercase', rules.lowercase);

        if (window.lucide) lucide.createIcons();
      }

      regPassword.addEventListener('input', () => {
        const rules = validatePassword(regPassword.value);
        updatePasswordUI(rules);
      });

      // Show requirements on focus
      regPassword.addEventListener('focus', () => {
        passwordRequirements.classList.remove('hidden');
      });




      // ----------------------------------------------------
      // DEMO LOGIN
      // ----------------------------------------------------
      demoLoginBtn?.addEventListener('click', () => {
        // Save demo user data to localStorage
        const demoUser = {
          user: {
            id: 'demo-user-123',
            username: 'demo_user',
            email: '',
            user_type: 'user'
          },
          token: 'demo-token-123456'
        };

        localStorage.setItem(NAME_KEY, JSON.stringify(demoUser));

        // Redirect to landing.html (logged-in view)
        window.location.replace('landing.html');
      });

      // ----------------------------------------------------
      // SHOW / HIDE FORMS
      // ----------------------------------------------------
      showRegisterBtn?.addEventListener('click', () => {
        loginBox.classList.add('hidden');
        registerBox.classList.remove('hidden');
      });


      backToLoginBtn?.addEventListener('click', () => {
        registerBox.classList.add('hidden');
        loginBox.classList.remove('hidden');
      });

      /* ---------------- FORGOT PASSWORD UI ---------------- */
      const forgotLink = document.getElementById('forgot-password-link');
      const forgotBox = document.getElementById('forgot-password-form');
      const backToLoginForgot = document.getElementById('back-to-login-forgot');
      const requestOtpForm = document.getElementById('requestOtpForm');
      const resetPasswordForm = document.getElementById('resetPasswordForm');
      const resetEmailInput = document.getElementById('reset-email');
      const resetEmailConfirm = document.getElementById('reset-email-confirm');

      forgotLink?.addEventListener('click', (e) => {
        e.preventDefault();
        loginBox.classList.add('hidden');
        forgotBox.classList.remove('hidden');
      });

      backToLoginForgot?.addEventListener('click', () => {
        forgotBox.classList.add('hidden');
        loginBox.classList.remove('hidden');
        // Reset forms
        requestOtpForm.reset();
        resetPasswordForm.reset();
        requestOtpForm.classList.remove('hidden');
        resetPasswordForm.classList.add('hidden');
      });

      // Handle Request OTP
      requestOtpForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = resetEmailInput.value.trim();
        if (!email) return;

        const btn = requestOtpForm.querySelector('button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Sending...';

        try {
          const res = await fetch(`${API_BASE}/api/auth/forgot-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          const data = await res.json();
          if (data.success) {
            alert(data.message);
            // Show next step
            requestOtpForm.classList.add('hidden');
            resetPasswordForm.classList.remove('hidden');
            resetEmailConfirm.value = email;
          } else {
            alert(data.error || 'Failed to send OTP');
          }
        } catch (err) {
          console.error(err);
          alert('Network error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      });

      // Handle Reset Password
      resetPasswordForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = resetEmailConfirm.value;
        const otp = document.getElementById('otp-code').value.trim();
        const newPassword = document.getElementById('new-password').value;

        if (!otp || !newPassword) return alert("Fill all fields");

        const btn = resetPasswordForm.querySelector('button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Resetting...';

        try {
          const res = await fetch(`${API_BASE}/api/auth/reset-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, otp, newPassword })
          });
          const data = await res.json();
          if (data.success) {
            alert("Password reset successfully! Please login.");
            forgotBox.classList.add('hidden');
            loginBox.classList.remove('hidden');
            requestOtpForm.reset();
            resetPasswordForm.reset();
          } else {
            alert(data.error || 'Reset failed');
          }
        } catch (err) {
          console.error(err);
          alert('Network error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      });



      // ----------------------------------------------------
      // LOGIN (REAL BACKEND)
      // ----------------------------------------------------
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = emailEl.value.trim();
        const password = passEl.value;

        if (!email || !password) {
          alert('Please fill all fields');
          return;
        }

        // Get the submit button that triggered the form
        const submitBtn = document.querySelector('button[form="loginForm"][type="submit"]');
        const original = submitBtn.innerHTML;

        try {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i data-lucide="loader" class="animate-spin w-4 h-4 mr-2"></i> Signing in...';
          lucide.createIcons();

          const res = await fetch(`${API_BASE}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email, password, rememberMe: rememberMeEl.checked })
          });

          const data = await res.json();

          if (!res.ok) {
            alert(data.error || 'Invalid credentials');
            return;
          }

          console.log('Login successful, data received:', data);

          // Save token + user in standardized format
          console.log('Login successful, saving user data:', data);
          const standardizedData = {
            isAuthenticated: true,
            user: data.user,
            userType: data.user?.user_type
          };
          localStorage.setItem(NAME_KEY, JSON.stringify(standardizedData));

          // Save theme if present
          if (data.theme_colors) {
            localStorage.setItem('planner.theme', JSON.stringify(data.theme_colors));
          }
          if (data.theme_id) {
            localStorage.setItem('planner.themeId', data.theme_id);
          }

          // Remember Me - Save/Clear Email
          if (rememberMeEl.checked) {
            localStorage.setItem('planner.rememberedEmail', email);
          } else {
            localStorage.removeItem('planner.rememberedEmail');
          }

          // Verify the data was saved
          const savedData = localStorage.getItem(NAME_KEY);
          console.log('Data saved to localStorage:', savedData);

          // Check if admin login - redirect to admin dashboard
          if (email === 'planneradmin@gmail.com' || data.user?.user_type === 'admin') {
            window.location.replace('admin/admin-dashboard.html');
            return;
          }

          // Regular user - redirect to landing.html
          window.location.replace('landing.html');

        } catch (err) {
          console.error(err);
          alert('Something went wrong. Try again.');
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = original;
            lucide.createIcons();
          }
        }
      });


      // ----------------------------------------------------
      // REGISTER (REAL BACKEND)
      // ----------------------------------------------------
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = regEmail.value.trim();
        const password = regPassword.value;
        const username = regUsername.value;
        const userType = document.getElementById('reg-user-type').value; // ADD THIS

        if (!email || !password || !username) {
          alert('Please fill all fields');
          return;
        }

        // Final Username Validation
        const uRules = validateUsername(username);
        const uValid = Object.values(uRules).every(r => r === true);
        if (!uValid) {
          alert("Please fix the username errors.");
          return;
        }

        // Final Password Validation
        const rules = validatePassword(password, username, email);
        const allValid = Object.values(rules).every(r => r === true);

        if (!allValid) {
          alert("Please fix the password errors before creating an account.");
          // Ideally scroll to error or highlighting, but alert is fine for now
          return;
        }

        const btn = registerForm.querySelector('button[type="submit"]');
        const original = btn.innerHTML;

        try {
          btn.disabled = true;
          btn.innerHTML = '<i data-lucide="loader" class="animate-spin w-4 h-4 mr-2"></i> Signing up...';
          lucide.createIcons();

          const res = await fetch(`${API_BASE}/api/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, username, userType })
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.error || 'Invalid credentials');
          }

          // SUCCESS: Do NOT auto-login.
          alert('Account created successfully! Please log in with your new credentials.');

          // Switch back to login form
          registerBox.classList.add('hidden');
          loginBox.classList.remove('hidden');

          // Pre-fill email
          emailEl.value = email;
          passEl.value = '';
          passEl.focus();

        } catch (err) {
          console.error('Register error:', err);
          alert(err.message || 'Register failed. Please check your credentials and try again.');
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = original;
            lucide.createIcons();
          }
        }
      });
    });
  </script>
</body>

</html>