<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login | PlanIT</title>
  <script src="/js/auth-helper.js"></script>
  <meta name="description" content="Log in to access your PlannIt account. Your data stays private and secure.">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="./css/styles.css?v=role1">
  <style>
    :root {
      --brand-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.2);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      margin: 0;
      overflow-x: hidden;
    }

    .login-container {
      min-height: 100vh;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      position: relative;
    }

    .login-container::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('https://www.transparenttextures.com/patterns/cubes.png');
      opacity: 0.08;
      pointer-events: none;
    }

    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 2rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      width: 100%;
      max-width: 1000px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slide-up 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @media (min-width: 768px) {
      .glass-card {
        flex-direction: row;
        min-height: 600px;
      }
    }

    @keyframes slide-up {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .info-side {
      background: var(--brand-gradient);
      padding: 3rem;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    @media (min-width: 768px) {
      .info-side {
        width: 45%;
      }
    }

    .info-side::after {
      content: '';
      position: absolute;
      bottom: -20%;
      right: -10%;
      width: 300px;
      height: 300px;
      background: white;
      opacity: 0.1;
      border-radius: 50%;
    }

    .form-side {
      padding: 3rem;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    @media (min-width: 768px) {
      .form-side {
        width: 55%;
      }
    }

    .input-group:focus-within label {
      color: #6366f1;
    }

    .btn-premium {
      background: var(--brand-gradient);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }

    .btn-premium:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
      filter: brightness(1.1);
    }

    .social-btn {
      transition: all 0.2s ease;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
    }

    .social-btn:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
  </style>
</head>

<body>
  <div class="login-container">
    <div class="glass-card">
      <!-- Info Pane -->
      <div class="info-side">
        <a href="./landing.html" class="flex items-center gap-3 mb-12 hover:opacity-80 transition-opacity">
          <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-lg">
            <i data-lucide="rocket" class="w-6 h-6 text-indigo-600"></i>
          </div>
          <span class="text-2xl font-black tracking-tight">Planexa</span>
        </a>

        <h2 class="text-3xl font-bold mb-6 leading-tight">Master your day, conquer your goals.</h2>
        <p class="text-indigo-100 mb-8 text-lg opacity-90">Join thousands of users who have transformed their
          productivity with Planexa's seamless experience.</p>

        <ul class="space-y-4">
          <li class="flex items-center gap-3">
            <div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center"><i data-lucide="check"
                class="w-4 h-4"></i></div>
            <span>Smart Task Prioritization</span>
          </li>
          <li class="flex items-center gap-3">
            <div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center"><i data-lucide="check"
                class="w-4 h-4"></i></div>
            <span>Cross-device Sync</span>
          </li>
          <li class="flex items-center gap-3">
            <div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center"><i data-lucide="check"
                class="w-4 h-4"></i></div>
            <span>Privacy-first Architecture</span>
          </li>
        </ul>

        <div class="mt-auto pt-12 text-sm text-indigo-200">
          &copy; 2026 Planexa. All rights reserved.
        </div>
      </div>

      <!-- Form Pane -->
      <div class="form-side">
        <!-- Login Section -->
        <div id="login-section">
          <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Welcome back</h1>
            <p class="text-gray-500">Please enter your details to sign in.</p>
          </div>

          <form id="loginForm" class="space-y-5">
            <div class="input-group">
              <label for="email" class="block text-sm font-semibold text-gray-700 mb-1.5 ml-1">Email address</label>
              <div class="relative group">
                <div
                  class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400 group-focus-within:text-indigo-500 transition-colors">
                  <i data-lucide="mail" class="h-5 w-5"></i>
                </div>
                <input id="email" name="email" type="email" autocomplete="email" required
                  class="block w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm"
                  placeholder="name@company.com">
              </div>
            </div>

            <div class="input-group">
              <div class="flex items-center justify-between mb-1.5 ml-1">
                <label for="password" class="block text-sm font-semibold text-gray-700">Password</label>
                <a href="#" id="forgot-password-link"
                  class="text-xs font-bold text-indigo-600 hover:text-indigo-500 transition-colors">Forgot password?</a>
              </div>
              <div class="relative group">
                <div
                  class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400 group-focus-within:text-indigo-500 transition-colors">
                  <i data-lucide="lock" class="h-5 w-5"></i>
                </div>
                <input id="password" name="password" type="password" autocomplete="current-password" required
                  class="block w-full pl-12 pr-12 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm"
                  placeholder="••••••••">
                <button type="button"
                  class="password-toggle absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-indigo-600 transition-colors focus:outline-none"
                  data-target="password">
                  <i data-lucide="eye" class="h-5 w-5"></i>
                </button>
              </div>
            </div>

            <div class="flex items-center justify-between py-1">
              <label class="flex items-center gap-2 cursor-pointer group">
                <div class="relative">
                  <input id="remember-me" name="remember-me" type="checkbox" class="sr-only peer">
                  <div
                    class="w-5 h-5 border-2 border-gray-300 rounded-md peer-checked:bg-indigo-600 peer-checked:border-indigo-600 transition-all">
                  </div>
                  <i data-lucide="check"
                    class="absolute inset-0 w-5 h-5 text-white opacity-0 peer-checked:opacity-100 p-0.5 pointer-events-none transition-opacity"></i>
                </div>
                <span class="text-sm text-gray-600 group-hover:text-gray-900 transition-colors">Remember me</span>
              </label>
            </div>

            <button type="submit" form="loginForm"
              class="btn-premium w-full py-3.5 rounded-2xl text-white font-bold text-sm flex items-center justify-center gap-2">
              <i data-lucide="log-in" class="w-4 h-4"></i> Sign in
            </button>
          </form>

          <div class="mt-8 pt-8 border-t border-gray-100">
            <p class="text-center text-sm text-gray-600">
              Don't have an account?
              <button id="show-register" type="button"
                class="font-bold text-indigo-600 hover:text-indigo-500 transition-colors">Create account</button>
            </p>
          </div>
        </div>

        <!-- Registration Section -->
        <div id="register-section" class="hidden">
          <div class="mb-6">
            <button id="back-to-login" type="button"
              class="flex items-center gap-2 text-indigo-600 font-bold text-sm hover:text-indigo-500 transition-colors mb-6">
              <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to login
            </button>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Join Planexa</h1>
            <p class="text-gray-500">Start your journey to better productivity.</p>
          </div>

          <form id="registerForm" class="space-y-4">
            <div class="input-group">
              <label for="reg-username" class="block text-sm font-semibold text-gray-700 mb-1.5 ml-1">Username</label>
              <div class="relative group">
                <div
                  class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400 group-focus-within:text-indigo-500 transition-colors">
                  <i data-lucide="user" class="h-5 w-5"></i>
                </div>
                <input id="reg-username" name="username" type="text" required
                  class="block w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm"
                  placeholder="yourname">
              </div>
              <div id="username-suggestions" class="mt-2 hidden">
                <p class="text-xs text-red-500 font-medium mb-1.5">Username is taken. Try one of these:</p>
                <div id="suggestion-buttons" class="flex flex-wrap gap-2"></div>
              </div>
            </div>

            <div class="input-group">
              <label for="reg-email" class="block text-sm font-semibold text-gray-700 mb-1.5 ml-1">Email address</label>
              <div class="relative group">
                <div
                  class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400 group-focus-within:text-indigo-500 transition-colors">
                  <i data-lucide="mail" class="h-5 w-5"></i>
                </div>
                <input id="reg-email" name="email" type="email" required
                  class="block w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm"
                  placeholder="you@example.com">
              </div>
            </div>

            <div class="input-group">
              <label for="reg-password" class="block text-sm font-semibold text-gray-700 mb-1.5 ml-1">Password</label>
              <div class="relative group">
                <div
                  class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400 group-focus-within:text-indigo-500 transition-colors">
                  <i data-lucide="lock" class="h-5 w-5"></i>
                </div>
                <input id="reg-password" name="password" type="password" required
                  class="block w-full pl-12 pr-12 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm"
                  placeholder="••••••••">
                <button type="button"
                  class="password-toggle absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-indigo-600 transition-colors focus:outline-none"
                  data-target="reg-password">
                  <i data-lucide="eye" class="h-5 w-5"></i>
                </button>
              </div>
              <!-- Password Requirements UI -->
              <div id="password-requirements"
                class="mt-3 p-3 bg-gray-50 rounded-xl text-[11px] text-gray-500 space-y-1.5 hidden border border-gray-100">
                <p class="font-bold text-gray-700 mb-1 caps">Security Requirements</p>
                <div id="rule-length" class="flex items-center gap-2"><i data-lucide="circle" class="w-3 h-3"></i> 8+
                  characters</div>
                <div id="rule-uppercase" class="flex items-center gap-2"><i data-lucide="circle" class="w-3 h-3"></i> At
                  least one uppercase</div>
                <div id="rule-lowercase" class="flex items-center gap-2"><i data-lucide="circle" class="w-3 h-3"></i> At
                  least one lowercase</div>
              </div>
            </div>

            <button type="submit"
              class="btn-premium w-full py-3.5 mt-4 rounded-2xl text-white font-bold text-sm flex items-center justify-center gap-2 transition-all">
              <i data-lucide="user-plus" class="w-4 h-4"></i> Create account
            </button>
          </form>
        </div>

        <!-- Forgot Password Section -->
        <div id="forgot-password-section" class="hidden">
          <div class="mb-6">
            <button id="back-to-login-forgot" type="button"
              class="flex items-center gap-2 text-indigo-600 font-bold text-sm hover:text-indigo-500 transition-colors mb-6">
              <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to login
            </button>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Reset Password</h1>
            <p class="text-gray-500">We'll send you an OTP to your email.</p>
          </div>

          <!-- Step 1: Request OTP -->
          <form id="requestOtpForm" class="space-y-5">
            <div class="input-group">
              <label for="reset-email" class="block text-sm font-semibold text-gray-700 mb-1.5 ml-1">Email
                address</label>
              <div class="relative group">
                <div
                  class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400 group-focus-within:text-indigo-500 transition-colors">
                  <i data-lucide="mail" class="h-5 w-5"></i>
                </div>
                <input id="reset-email" name="email" type="email" required
                  class="block w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm"
                  placeholder="you@example.com">
              </div>
            </div>
            <button type="submit" class="btn-premium w-full py-3.5 rounded-2xl text-white font-bold text-sm">Send OTP
              Code</button>
          </form>

          <!-- Step 2: Verify OTP & Reset -->
          <form id="resetPasswordForm" class="space-y-5 hidden">
            <div class="p-3 bg-blue-50 text-blue-800 rounded-xl text-xs font-medium border border-blue-100 mb-4">
              Enter the OTP sent to your email. Check console if testing locally.
            </div>

            <input type="hidden" id="reset-email-confirm">

            <div class="input-group text-center">
              <label for="otp-code" class="block text-sm font-semibold text-gray-700 mb-2">OTP Code</label>
              <input id="otp-code" name="otp" type="text" required placeholder="123456"
                class="block w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all tracking-[0.5em] text-center font-mono text-xl">
            </div>

            <div class="input-group">
              <label for="new-password" class="block text-sm font-semibold text-gray-700 mb-1.5 ml-1">New
                Password</label>
              <div class="relative group">
                <div
                  class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400 group-focus-within:text-indigo-500 transition-colors">
                  <i data-lucide="lock" class="h-5 w-5"></i>
                </div>
                <input id="new-password" name="newPassword" type="password" required
                  class="block w-full pl-12 pr-12 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm"
                  placeholder="••••••••">
                <button type="button"
                  class="password-toggle absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-indigo-600 transition-colors focus:outline-none"
                  data-target="new-password">
                  <i data-lucide="eye" class="h-5 w-5"></i>
                </button>
              </div>
            </div>

            <button type="submit"
              class="w-full py-3.5 bg-green-600 hover:bg-green-700 text-white rounded-2xl font-bold text-sm shadow-lg shadow-green-600/20 transition-all hover:-translate-y-0.5">Reset
              Password</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();

      const API_BASE = ''; // Use relative paths in production
      const NAME_KEY = 'planner.user';

      // ---------------------------
      // PASSWORD TOGGLE LOGIC
      // ---------------------------
      document.querySelectorAll('.password-toggle').forEach(button => {
        button.addEventListener('click', () => {
          const targetId = button.getAttribute('data-target');
          const input = document.getElementById(targetId);
          const icon = button.querySelector('i');

          if (input.type === 'password') {
            input.type = 'text';
            icon.setAttribute('data-lucide', 'eye-off');
          } else {
            input.type = 'password';
            icon.setAttribute('data-lucide', 'eye');
          }
          lucide.createIcons();
        });
      });

      <!-- Redundant manual redirect replaced by auth-helper.js -->

      // PRE-FILL REMEMBERED EMAIL
      const rememberedEmail = localStorage.getItem('planner.rememberedEmail');
      if (rememberedEmail) {
        const emailInput = document.getElementById('email');
        if (emailInput) {
          emailInput.value = rememberedEmail;
          const rememberMeCheckbox = document.getElementById('remember-me');
          if (rememberMeCheckbox) rememberMeCheckbox.checked = true;
        }
      }

      // ---------------------------
      // ELEMENTS
      // ---------------------------
      const loginForm = document.getElementById('loginForm');
      const emailEl = document.getElementById('email');
      const passEl = document.getElementById('password');
      const rememberMeEl = document.getElementById('remember-me');
      const demoLoginBtn = document.getElementById('demo-login');

      const showRegisterBtn = document.getElementById('show-register');
      const backToLoginBtn = document.getElementById('back-to-login');

      const loginSection = document.getElementById('login-section');
      const registerSection = document.getElementById('register-section');
      const forgotSection = document.getElementById('forgot-password-section');

      const registerForm = document.getElementById('registerForm');
      const regUsername = document.getElementById('reg-username');






      const regEmail = document.getElementById('reg-email');

      const regPassword = document.getElementById('reg-password');
      const passwordRequirements = document.getElementById('password-requirements');

      // Password Validation Logic
      function validatePassword(password) {
        const rules = {
          length: password.length >= 8,
          uppercase: /[A-Z]/.test(password),
          lowercase: /[a-z]/.test(password)
        };
        return rules;
      }

      function updatePasswordUI(rules) {
        passwordRequirements.classList.remove('hidden');

        const updateItem = (id, isValid) => {
          const el = document.getElementById(id);
          if (!el) return; // FIX: Prevents null pointer error
          const icon = el.querySelector('i');
          if (!icon) return; // FIX: Extra safety

          if (isValid) {
            el.classList.remove('text-gray-500', 'text-red-500');
            el.classList.add('text-green-600');
            icon.setAttribute('data-lucide', 'check-circle');
          } else {
            el.classList.remove('text-green-600');
            el.classList.add('text-gray-500');
            icon.setAttribute('data-lucide', 'circle');
          }
        };

        updateItem('rule-length', rules.length);
        updateItem('rule-uppercase', rules.uppercase);
        updateItem('rule-lowercase', rules.lowercase);

        if (window.lucide) lucide.createIcons();
      }

      regPassword.addEventListener('input', () => {
        const rules = validatePassword(regPassword.value);
        updatePasswordUI(rules);
      });

      // Show requirements on focus
      regPassword.addEventListener('focus', () => {
        passwordRequirements.classList.remove('hidden');
      });




      // ----------------------------------------------------
      // DEMO LOGIN
      // ----------------------------------------------------
      demoLoginBtn?.addEventListener('click', () => {
        // Save demo user data to localStorage
        const demoUser = {
          user: {
            id: 'demo-user-123',
            username: 'demo_user',
            email: '',
            user_type: 'user'
          },
          token: 'demo-token-123456'
        };

        localStorage.setItem(NAME_KEY, JSON.stringify(demoUser));

        // Redirect to landing.html (logged-in view)
        window.location.replace('landing.html');
      });

      // ----------------------------------------------------
      // SHOW / HIDE FORMS
      // ----------------------------------------------------
      showRegisterBtn?.addEventListener('click', () => {
        loginSection.classList.add('hidden');
        registerSection.classList.remove('hidden');
      });


      backToLoginBtn?.addEventListener('click', () => {
        registerSection.classList.add('hidden');
        loginSection.classList.remove('hidden');
      });

      /* ---------------- FORGOT PASSWORD UI ---------------- */
      const forgotLink = document.getElementById('forgot-password-link');
      const backToLoginForgot = document.getElementById('back-to-login-forgot');
      const requestOtpForm = document.getElementById('requestOtpForm');
      const resetPasswordForm = document.getElementById('resetPasswordForm');
      const resetEmailInput = document.getElementById('reset-email');
      const resetEmailConfirm = document.getElementById('reset-email-confirm');

      forgotLink?.addEventListener('click', (e) => {
        e.preventDefault();
        loginSection.classList.add('hidden');
        forgotSection.classList.remove('hidden');
      });

      backToLoginForgot?.addEventListener('click', () => {
        forgotSection.classList.add('hidden');
        loginSection.classList.remove('hidden');
        // Reset forms
        requestOtpForm.reset();
        resetPasswordForm.reset();
        requestOtpForm.classList.remove('hidden');
        resetPasswordForm.classList.add('hidden');
      });

      // Handle Request OTP
      requestOtpForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = resetEmailInput.value.trim();
        if (!email) return;

        const btn = requestOtpForm.querySelector('button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Sending...';

        try {
          const res = await fetch(`${API_BASE}/api/auth/forgot-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          const data = await res.json();
          if (data.success) {
            alert(data.message);
            // Show next step
            requestOtpForm.classList.add('hidden');
            resetPasswordForm.classList.remove('hidden');
            resetEmailConfirm.value = email;
          } else {
            alert(data.error || 'Failed to send OTP');
          }
        } catch (err) {
          console.error(err);
          alert('Network error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      });

      // Handle Reset Password
      resetPasswordForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = resetEmailConfirm.value;
        const otp = document.getElementById('otp-code').value.trim();
        const newPassword = document.getElementById('new-password').value;

        if (!otp || !newPassword) return alert("Fill all fields");

        const btn = resetPasswordForm.querySelector('button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Resetting...';

        try {
          const res = await fetch(`${API_BASE}/api/auth/reset-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, otp, newPassword })
          });
          const data = await res.json();
          if (data.success) {
            alert("Password reset successfully! Please login.");
            forgotSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
            requestOtpForm.reset();
            resetPasswordForm.reset();
          } else {
            alert(data.error || 'Reset failed');
          }
        } catch (err) {
          console.error(err);
          alert('Network error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      });



      // ----------------------------------------------------
      // LOGIN (REAL BACKEND)
      // ----------------------------------------------------
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = emailEl.value.trim();
        const password = passEl.value;

        if (!email || !password) {
          alert('Please fill all fields');
          return;
        }

        // Get the submit button that triggered the form
        const submitBtn = document.querySelector('button[form="loginForm"][type="submit"]');
        const original = submitBtn.innerHTML;

        try {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i data-lucide="loader" class="animate-spin w-4 h-4 mr-2"></i> Signing in...';
          lucide.createIcons();

          const res = await fetch(`${API_BASE}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email, password, rememberMe: rememberMeEl.checked })
          });

          const data = await res.json();

          if (!res.ok) {
            alert(data.error || 'Invalid credentials');
            return;
          }

          console.log('Login successful, data received:', data);

          // Save token + user in standardized format
          console.log('Login successful, saving user data:', data);
          const standardizedData = {
            isAuthenticated: true,
            user: data.user,
            userType: data.user?.user_type
          };
          localStorage.setItem(NAME_KEY, JSON.stringify(standardizedData));

          // Save theme if present
          if (data.theme_colors) {
            localStorage.setItem('planner.theme', JSON.stringify(data.theme_colors));
          }
          if (data.theme_id) {
            localStorage.setItem('planner.themeId', data.theme_id);
          }

          // Remember Me - Save/Clear Email
          if (rememberMeEl.checked) {
            localStorage.setItem('planner.rememberedEmail', email);
          } else {
            localStorage.removeItem('planner.rememberedEmail');
          }

          // Verify the data was saved
          const savedData = localStorage.getItem(NAME_KEY);
          console.log('Data saved to localStorage:', savedData);

          // Check if admin login - redirect to admin dashboard
          if (email === 'pht.intern05@gmail.com' || data.user?.user_type === 'admin') {
            window.location.replace('admin/admin-dashboard.html');
            return;
          }

          // Regular user - redirect to landing.html
          window.location.replace('landing.html');

        } catch (err) {
          console.error(err);
          alert('Something went wrong. Try again.');
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = original;
            lucide.createIcons();
          }
        }
      });


      // ----------------------------------------------------
      // REGISTER (REAL BACKEND)
      // ----------------------------------------------------
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = regEmail.value.trim();
        const password = regPassword.value;
        const username = regUsername.value;
        const userType = 'user'; // Default user type

        if (!email || !password || !username) {
          alert('Please fill all fields');
          return;
        }



        // Final Password Validation
        const rules = validatePassword(password, username, email);
        const allValid = Object.values(rules).every(r => r === true);

        if (!allValid) {
          alert("Please fix the password errors before creating an account.");
          // Ideally scroll to error or highlighting, but alert is fine for now
          return;
        }

        const btn = registerForm.querySelector('button[type="submit"]');
        const original = btn.innerHTML;

        try {
          btn.disabled = true;
          btn.innerHTML = '<i data-lucide="loader" class="animate-spin w-4 h-4 mr-2"></i> Signing up...';
          lucide.createIcons();

          const res = await fetch(`${API_BASE}/api/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, username, userType })
          });

          const data = await res.json();

          if (!res.ok) {
            const err = new Error(data.error || 'Invalid credentials');
            err.suggestions = data.suggestions || [];
            throw err;
          }

          // SUCCESS: Do NOT auto-login.
          alert('Account created successfully! Please log in with your new credentials.');

          // Clear any stale local session data
          localStorage.removeItem('planner.user');
          localStorage.removeItem('planner.theme');
          localStorage.removeItem('planner.themeId');

          // Switch back to login form
          registerSection.classList.add('hidden');
          loginSection.classList.remove('hidden');

          // Pre-fill email
          emailEl.value = email;
          passEl.value = '';
          passEl.focus();

        } catch (err) {
          console.error('Register error:', err);
          // Check if it's a username-taken error with suggestions
          if (err.suggestions && err.suggestions.length > 0) {
            const suggestionsBox = document.getElementById('username-suggestions');
            const buttonsContainer = document.getElementById('suggestion-buttons');
            buttonsContainer.innerHTML = '';
            err.suggestions.forEach(name => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.textContent = name;
              btn.className = 'px-3 py-1 text-xs font-medium bg-indigo-50 text-indigo-700 border border-indigo-200 rounded-full hover:bg-indigo-100 transition-colors cursor-pointer';
              btn.addEventListener('click', () => {
                regUsername.value = name;
                suggestionsBox.classList.add('hidden');
                regUsername.classList.remove('border-red-400');
                regUsername.classList.add('border-gray-300');
              });
              buttonsContainer.appendChild(btn);
            });
            suggestionsBox.classList.remove('hidden');
            regUsername.classList.remove('border-gray-300');
            regUsername.classList.add('border-red-400');
            regUsername.focus();
          } else {
            alert(err.message || 'Register failed. Please check your credentials and try again.');
          }
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = original;
            lucide.createIcons();
          }
        }
      });
    });
  </script>
</body>

</html>